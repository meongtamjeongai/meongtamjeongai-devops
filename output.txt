# ğŸ“Š Project Analysis Summary

- **Root Directory**: D:\meongtamjeongai-devops
- **Generated on**: 2025-06-10 00:40:48
- **Total Files Included**: 26
- **Total Lines of Content**: 2276
- **Total Characters**: 66780
- **Approximate Tokens**: 16695 (Note: A rough estimate, 1 token â‰ˆ 4 chars)

---

# ğŸŒ³ Directory Tree

```
â”œâ”€â”€ locals.tf
â”œâ”€â”€ main.tf
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ acm/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ versions.tf
â”‚   â”œâ”€â”€ alb/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â”œâ”€â”€ ec2_backend/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â”œâ”€â”€ user_data.sh
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â”œâ”€â”€ nat_instance/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â”œâ”€â”€ rds/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ variables.tf
â”‚   â””â”€â”€ vpc/
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ outputs.tf
â”‚       â””â”€â”€ variables.tf
â”œâ”€â”€ outputs.tf
â”œâ”€â”€ providers.tf
â”œâ”€â”€ variables.tf
â””â”€â”€ versions.tf
```

# ğŸ“š Combined Code Files

--- START OF locals.tf ---
# terraform-aws-fastapi-infra/locals.tf

locals {
  common_tags = {
    Project     = var.project_name
    Environment = var.environment
    ManagedBy   = "Terraform"
    CreatedAt   = timestamp()
  }
}

--- END OF locals.tf ---

--- START OF main.tf ---
# terraform-aws-fastapi-infra/main.tf
#
# ì´ íŒŒì¼ì€ ì „ì²´ ì¸í”„ë¼ ìŠ¤íƒì˜ ì£¼ ì§„ì…ì  ì—­í• ì„ í•©ë‹ˆë‹¤.
# ë‹¤ì–‘í•œ ëª¨ë“ˆì„ í˜¸ì¶œí•˜ê³ , ê° ëª¨ë“ˆ ê°„ì˜ ì˜ì¡´ì„±ì„ ì—°ê²°í•©ë‹ˆë‹¤.

# -----------------------------------------------------------------------------
# 0. ACM ì¸ì¦ì„œ ìƒì„± (Cloudflare DNS ê²€ì¦)
# -----------------------------------------------------------------------------
module "acm" {
  source = "./modules/acm"

  project_name = var.project_name
  environment  = var.environment
  common_tags  = local.common_tags

  domain_name               = var.domain_name                                                                      # ì˜ˆ: "mydomain.com"
  subject_alternative_names = var.subdomain_for_cert != "" ? ["${var.subdomain_for_cert}.${var.domain_name}"] : [] # ì˜ˆ: ["www.mydomain.com"]
  # ë§Œì•½ ì—¬ëŸ¬ SANì´ í•„ìš”í•˜ë©´, subject_alternative_names = ["www.${var.domain_name}", "api.${var.domain_name}"] ì™€ ê°™ì´ ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬ì„±
  cloudflare_zone_id = var.cloudflare_zone_id
}

# -----------------------------------------------------------------------------
# 1. VPC ë° ë„¤íŠ¸ì›Œí¬ ì¸í”„ë¼ (VPC, ì„œë¸Œë„·, ë¼ìš°íŒ… í…Œì´ë¸”, NAT ì¸ìŠ¤í„´ìŠ¤)
# -----------------------------------------------------------------------------

# VPC ëª¨ë“ˆ í˜¸ì¶œ: ë„¤íŠ¸ì›Œí¬ì˜ ê¸°ë°˜ì„ ì •ì˜í•©ë‹ˆë‹¤.
module "vpc" {
  source = "./modules/vpc"

  aws_region   = var.aws_region
  project_name = var.project_name
  environment  = var.environment
  common_tags  = local.common_tags

  availability_zones        = var.availability_zones    # ğŸ‘ˆ ë£¨íŠ¸ì˜ list(string) ë³€ìˆ˜ ì „ë‹¬
  public_subnet_cidrs       = var.public_subnet_cidrs   # ğŸ‘ˆ ë£¨íŠ¸ì˜ list(string) ë³€ìˆ˜ ì „ë‹¬
  primary_availability_zone = var.availability_zones[0] # ğŸ‘ˆ í”„ë¼ì´ë¹— ì„œë¸Œë„·ìš© AZ (ì˜ˆ: ë¦¬ìŠ¤íŠ¸ì˜ ì²« ë²ˆì§¸ AZ ì‚¬ìš©)

  # ë£¨íŠ¸ variables.tfì— ì •ì˜ëœ CIDR ê°’ë“¤ì„ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬
  vpc_cidr_block          = var.vpc_cidr_block
  private_subnet_app_cidr = var.private_subnet_app_cidr
  private_db_subnet_cidrs = var.private_db_subnet_cidrs
}

# NAT ì¸ìŠ¤í„´ìŠ¤ ëª¨ë“ˆ í˜¸ì¶œ: í”„ë¼ì´ë¹— ì„œë¸Œë„·ì˜ ì•„ì›ƒë°”ìš´ë“œ ì¸í„°ë„· ì•¡ì„¸ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
module "nat_instance" {
  source = "./modules/nat_instance"

  project_name     = var.project_name
  environment      = var.environment
  common_tags      = local.common_tags
  public_subnet_id = module.vpc.public_subnet_ids[0]
  vpc_id           = module.vpc.vpc_id # VPC ëª¨ë“ˆì˜ ì¶œë ¥ê°’ ì‚¬ìš©

  private_subnet_cidrs = concat(
    [var.private_subnet_app_cidr], # ë‹¨ì¼ ì•± í”„ë¼ì´ë¹— ì„œë¸Œë„· CIDR
    var.private_db_subnet_cidrs    # DB í”„ë¼ì´ë¹— ì„œë¸Œë„· CIDR ëª©ë¡ (ë¦¬ìŠ¤íŠ¸)
  )

  # admin_app_port         = 8080 # ë˜ëŠ” var.admin_app_port ë“±ìœ¼ë¡œ ê´€ë¦¬
  # admin_app_source_cidrs = ["YOUR_OFFICE_IP/32", "YOUR_HOME_IP/32"] # ì˜ˆì‹œ: ì‚¬ë¬´ì‹¤ ë° ì§‘ IPë§Œ í—ˆìš©

  depends_on = [module.vpc] # VPCê°€ ë¨¼ì € ìƒì„±ë˜ë„ë¡ ì˜ì¡´ì„± ëª…ì‹œ
}

# í”„ë¼ì´ë¹— ë¼ìš°íŠ¸ í…Œì´ë¸”ì— NAT ì¸ìŠ¤í„´ìŠ¤ë¡œ í–¥í•˜ëŠ” ë¼ìš°íŒ… ê·œì¹™ ì¶”ê°€:
# ì•± ë° DB í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ ì™¸ë¶€ë¡œ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ì„ NAT ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¼ìš°íŒ…í•©ë‹ˆë‹¤.
resource "aws_route" "private_app_subnet_to_nat" {
  route_table_id         = module.vpc.private_app_route_table_id            # VPC ëª¨ë“ˆ ì¶œë ¥: ì•± ë¼ìš°íŠ¸ í…Œì´ë¸” ID
  destination_cidr_block = "0.0.0.0/0"                                      # ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½
  network_interface_id   = module.nat_instance.primary_network_interface_id # NAT ì¸ìŠ¤í„´ìŠ¤ ëª¨ë“ˆ ì¶œë ¥: ENI ID

  # NAT ì¸ìŠ¤í„´ìŠ¤ê°€ ì™„ì „íˆ ì¤€ë¹„ëœ í›„ ë¼ìš°íŠ¸ê°€ ì¶”ê°€ë˜ë„ë¡ ëª…ì‹œì  ì˜ì¡´ì„± ì„¤ì • (ì„ íƒì ì´ì§€ë§Œ ê¶Œì¥)
  depends_on = [module.nat_instance]
}

resource "aws_route" "private_db_subnet_to_nat" {
  route_table_id         = module.vpc.private_db_route_table_id             # VPC ëª¨ë“ˆ ì¶œë ¥: DB ë¼ìš°íŠ¸ í…Œì´ë¸” ID
  destination_cidr_block = "0.0.0.0/0"                                      # ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½
  network_interface_id   = module.nat_instance.primary_network_interface_id # NAT ì¸ìŠ¤í„´ìŠ¤ ëª¨ë“ˆ ì¶œë ¥: ENI ID

  depends_on = [module.nat_instance]
}

# -----------------------------------------------------------------------------
# 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë° ë¡œë“œ ë°¸ëŸ°ì‹± (ALB, EC2 ë°±ì—”ë“œ)
# -----------------------------------------------------------------------------

# ë°±ì—”ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ìš© AMI ì¡°íšŒ (Amazon Linux 2): EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì‚¬ìš©ë  AMIë¥¼ ì°¾ìŠµë‹ˆë‹¤.
data "aws_ami" "amazon_linux_2_for_backend" {
  most_recent = true
  owners      = ["amazon"] # Amazon ì œê³µ AMI

  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-gp2"] # Amazon Linux 2 ìµœì‹  HVM GP2 AMI
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}

# ALB ëª¨ë“ˆ í˜¸ì¶œ: ì• í”Œë¦¬ì¼€ì´ì…˜ íŠ¸ë˜í”½ì„ EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¶„ì‚°í•©ë‹ˆë‹¤.
module "alb" {
  source = "./modules/alb"

  project_name      = var.project_name
  environment       = var.environment
  common_tags       = local.common_tags
  vpc_id            = module.vpc.vpc_id
  public_subnet_ids = module.vpc.public_subnet_ids # ğŸ‘ˆ VPC ëª¨ë“ˆì˜ list ì¶œë ¥ê°’ ì „ë‹¬

  backend_app_port = var.backend_app_port # ë£¨íŠ¸ì˜ backend_app_port -> albì˜ backend_app_portë¡œ ì „ë‹¬

  create_https_listener = var.domain_name != "" && var.cloudflare_zone_id != ""
  certificate_arn       = module.acm.validated_certificate_arn

  # ALBëŠ” VPC ëª¨ë“ˆê³¼ ACM ëª¨ë“ˆ(ì¸ì¦ì„œ)ì— ì˜ì¡´í•©ë‹ˆë‹¤.
  depends_on = [module.vpc, module.acm]
}

# EC2 ë°±ì—”ë“œ ëª¨ë“ˆ í˜¸ì¶œ: FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í˜¸ìŠ¤íŒ…í•˜ëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ ë° ASGë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
module "ec2_backend" {
  source = "./modules/ec2_backend"

  project_name           = var.project_name
  environment            = var.environment
  common_tags            = local.common_tags
  vpc_id                 = module.vpc.vpc_id
  private_app_subnet_ids = [module.vpc.private_app_subnet_id]
  ami_id                 = data.aws_ami.amazon_linux_2_for_backend.id
  instance_type          = "t2.micro"

  aws_region           = var.aws_region
  fastapi_docker_image = var.custom_fastapi_docker_image # ğŸ‘ˆ ë£¨íŠ¸ ë³€ìˆ˜ ê°’ì„ ëª¨ë“ˆì˜ ì…ë ¥ìœ¼ë¡œ ì „ë‹¬
  host_app_port        = var.backend_app_port            # ë£¨íŠ¸ì˜ backend_app_port -> ec2_backendì˜ host_app_portë¡œ ì „ë‹¬
  fastapi_app_port     = 80                              # Dockerfile EXPOSE ë° CMD í¬íŠ¸ì™€ ì¼ì¹˜í•˜ë„ë¡ ì„¤ì • (ë˜ëŠ” ë³€ìˆ˜í™”)

  # ğŸ¯ ALB ëŒ€ìƒ ê·¸ë£¹ ARN ì „ë‹¬
  target_group_arns          = [module.alb.target_group_arn] # module.albê°€ ìƒì„±ëœ í›„ì— ì´ ê°’ì´ ê²°ì •ë¨
  health_check_type          = "ELB"                         # ëª…ì‹œì ìœ¼ë¡œ ELB ì‚¬ìš©
  health_check_grace_period  = 60                            # ASG í—¬ìŠ¤ ì²´í¬ ìœ ì˜ˆ
  asg_instance_warmup        = 30                            # ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ ì‹œ ì¤€ë¹„ ì‹œê°„
  asg_min_healthy_percentage = 100                           # ìµœì†Œ ì •ìƒ ì¸ìŠ¤í„´ìŠ¤ ìœ ì§€

  fastapi_database_url = "postgresql://${module.rds.db_instance_username}:${var.db_password}@${module.rds.db_instance_endpoint}/${module.rds.db_instance_name}"
  fastapi_secret_key   = var.fastapi_secret_key
  firebase_b64_json    = var.firebase_b64_json

  # ëª…í™•í•œ ì˜ì¡´ì„± ì„ ì–¸ (nat_instance ë° alb ëª¨ë“ˆì´ ì™„ë£Œëœ í›„ ì‹¤í–‰)
  depends_on = [module.vpc, module.nat_instance, module.alb]
}

# ALBì—ì„œ ë°±ì—”ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ë¡œì˜ íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ëŠ” ë³´ì•ˆ ê·¸ë£¹ ê·œì¹™ ì¶”ê°€:
# ALBì™€ EC2 ì¸ìŠ¤í„´ìŠ¤ ê°„ì˜ í†µì‹ ì„ í—ˆìš©í•©ë‹ˆë‹¤.
resource "aws_security_group_rule" "allow_alb_to_backend" {
  type                     = "ingress"
  description              = "Allow traffic from ALB to backend EC2 instances on app port"
  from_port                = var.backend_app_port # ë£¨íŠ¸ì˜ backend_app_port ì‚¬ìš©
  to_port                  = var.backend_app_port # ë£¨íŠ¸ì˜ backend_app_port ì‚¬ìš©
  protocol                 = "tcp"
  security_group_id        = module.ec2_backend.security_group_id # ëŒ€ìƒ: ë°±ì—”ë“œ SG
  source_security_group_id = module.alb.security_group_id         # ì†ŒìŠ¤: ALB SG

  # ì´ ê·œì¹™ì€ albì™€ ec2_backend ëª¨ë“ˆì´ ê°ê°ì˜ SGë¥¼ ë§Œë“  í›„ì— ì ìš©ë¨
  depends_on = [module.alb, module.ec2_backend]
}

# -----------------------------------------------------------------------------
# 3. ë°ì´í„°ë² ì´ìŠ¤ (RDS)
# -----------------------------------------------------------------------------

# RDS ëª¨ë“ˆ í˜¸ì¶œ: ë°ì´í„°ë² ì´ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
module "rds" {
  source = "./modules/rds" # ./modules/rds ë””ë ‰í† ë¦¬ ì°¸ì¡°

  # í•„ìˆ˜ ì…ë ¥ ë³€ìˆ˜ ì „ë‹¬
  project_name  = var.project_name
  environment   = var.environment
  common_tags   = local.common_tags
  vpc_id        = module.vpc.vpc_id                # VPC ëª¨ë“ˆ ì¶œë ¥ê°’
  db_subnet_ids = module.vpc.private_db_subnet_ids # VPC ëª¨ë“ˆ ì¶œë ¥ê°’ (í˜„ì¬ ë‹¨ì¼ DB ì„œë¸Œë„·)
  db_password   = var.db_password                  # ë£¨íŠ¸ variables.tf (Terraform Cloudì—ì„œ ì£¼ì…)

  # ì˜ì¡´ì„±: VPC ëª¨ë“ˆ(ì„œë¸Œë„· ID, VPC ID)ê³¼ EC2 ë°±ì—”ë“œ ëª¨ë“ˆ(ë³´ì•ˆ ê·¸ë£¹ ID)ì´ ì™„ë£Œëœ í›„ ì‹¤í–‰
  depends_on = [module.vpc, module.ec2_backend]
}

resource "aws_security_group_rule" "allow_ec2_to_rds" {
  type                     = "ingress"
  description              = "Allow traffic from Backend EC2 to RDS"
  from_port                = module.rds.db_instance_port # rds ëª¨ë“ˆì˜ ì¶œë ¥ê°’ ì‚¬ìš©
  to_port                  = module.rds.db_instance_port # rds ëª¨ë“ˆì˜ ì¶œë ¥ê°’ ì‚¬ìš©
  protocol                 = "tcp"
  security_group_id        = module.rds.rds_security_group_id     # ëŒ€ìƒ: RDS ë³´ì•ˆ ê·¸ë£¹
  source_security_group_id = module.ec2_backend.security_group_id # ì†ŒìŠ¤: EC2 ë³´ì•ˆ ê·¸ë£¹

  # ì´ ê·œì¹™ì€ rdsì™€ ec2_backend ëª¨ë“ˆì´ ëª¨ë‘ ìƒì„±ëœ í›„ì— ì ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
  depends_on = [module.rds, module.ec2_backend]
}

# -----------------------------------------------------------------------------
# 4. ê¸°íƒ€ ì„œë¹„ìŠ¤ (ECR)
# -----------------------------------------------------------------------------

# ECR ë ˆí¬ì§€í† ë¦¬ ìƒì„±: FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ Docker ì´ë¯¸ì§€ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
resource "aws_ecr_repository" "fastapi_app" {
  name                 = "${var.project_name}-${var.environment}-fastapi-app" # ì˜ˆ: fastapi-infra-dev-fastapi-app
  image_tag_mutability = "MUTABLE"                                            # ë˜ëŠ” "IMMUTABLE". MUTABLEì€ íƒœê·¸ ì¬ì‚¬ìš© ê°€ëŠ¥, IMMUTABLEì€ ë¶ˆê°€.
  # ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ê³ ìœ  íƒœê·¸ì— IMMUTABLEì„ ê¶Œì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  image_scanning_configuration {
    scan_on_push = true # ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œ ì·¨ì•½ì  ìŠ¤ìº” í™œì„±í™”
  }

  tags = merge(local.common_tags, {
    Purpose = "FastAPI Application Docker Images"
  })
}

resource "aws_ecr_repository" "admin_app" {
  # FastAPI ì•±ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ê³ ìœ í•œ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤. (ì˜ˆ: ...-admin-app)
  name                 = "${var.project_name}-${var.environment}-admin-app"
  image_tag_mutability = "MUTABLE"

  image_scanning_configuration {
    scan_on_push = true
  }

  tags = merge(local.common_tags, {
    Purpose = "Admin Application Docker Images"
  })
}

# -----------------------------------------------------------------------------
# 5. Cloudflare DNS ë ˆì½”ë“œ ìƒì„± (ALBìš© CNAME)
# -----------------------------------------------------------------------------

# 5.1. íŠ¹ì • ì„œë¸Œë„ë©”ì¸ìš© CNAME (ì˜ˆ: www.example.com)
resource "cloudflare_dns_record" "alb_subdomain_cname" {
  # var.subdomain_for_cert ë¹„ì–´ìˆì§€ ì•Šê³ , ê¸°ë³¸ ì¡°ê±´ ë§Œì¡± ì‹œ ìƒì„±
  #count = var.domain_name != "" && var.cloudflare_zone_id != "" && module.alb.alb_dns_name != null && var.subdomain_for_cert != "" ? 1 : 0
  count = var.domain_name != "" && var.cloudflare_zone_id != "" && var.subdomain_for_cert != "" ? 1 : 0

  zone_id = var.cloudflare_zone_id
  name    = var.subdomain_for_cert # ì˜ˆ: "www"
  content = module.alb.alb_dns_name
  type    = "CNAME"
  proxied = true
  ttl     = 1
}

# 5.2. ë£¨íŠ¸ ë„ë©”ì¸ìš© CNAME (ì˜ˆ: example.com)
resource "cloudflare_dns_record" "alb_root_cname" {
  # ê¸°ë³¸ ì¡°ê±´ ë§Œì¡± ì‹œ ìƒì„±
  #count = var.domain_name != "" && var.cloudflare_zone_id != "" && module.alb.alb_dns_name != null ? 1 : 0
  count = var.domain_name != "" && var.cloudflare_zone_id != "" ? 1 : 0

  zone_id = var.cloudflare_zone_id
  name    = var.domain_name # Cloudflareì—ì„œëŠ” ë£¨íŠ¸ ë„ë©”ì¸ì„ ë‚˜íƒ€ë‚¼ ë•Œ ì‹¤ì œ ë„ë©”ì¸ ì´ë¦„ ë˜ëŠ” "@" ì‚¬ìš© ê°€ëŠ¥
  # ì—¬ê¸°ì„œëŠ” var.domain_name ì‚¬ìš©
  content = module.alb.alb_dns_name
  type    = "CNAME" # Cloudflareê°€ CNAME Flattening ì²˜ë¦¬
  proxied = true
  ttl     = 1
}

# 5.3. ì™€ì¼ë“œì¹´ë“œ ì„œë¸Œë„ë©”ì¸ìš© CNAME (ì˜ˆ: *.example.com)
resource "cloudflare_dns_record" "alb_wildcard_cname" {
  # ê¸°ë³¸ ì¡°ê±´ ë§Œì¡± ì‹œ ìƒì„±
  # count = var.domain_name != "" && var.cloudflare_zone_id != "" && module.alb.alb_dns_name != null ? 1 : 0
  count = var.domain_name != "" && var.cloudflare_zone_id != "" ? 1 : 0

  zone_id = var.cloudflare_zone_id
  name    = "*" # ì™€ì¼ë“œì¹´ë“œ
  content = module.alb.alb_dns_name
  type    = "CNAME"
  proxied = true
  ttl     = 1
}

--- END OF main.tf ---

--- START OF modules/acm/main.tf ---
# modules/acm/main.tf

locals {
  module_tags = merge(var.common_tags, {
    TerraformModule = "acm"
    Name            = "${var.project_name}-acm-cert-${var.environment}"
  })
}

resource "aws_acm_certificate" "this" {
  domain_name               = var.domain_name
  subject_alternative_names = var.subject_alternative_names
  validation_method         = "DNS"

  tags = local.module_tags

  lifecycle {
    create_before_destroy = true
  }
}

resource "cloudflare_dns_record" "validation" {
  for_each = {
    for dvo in aws_acm_certificate.this.domain_validation_options : dvo.domain_name => {
      # dvo.resource_record_name ì€ FQDN í˜•íƒœ (_xyz.example.com.)
      # dvo.resource_record_value ëŠ” CNAME ëŒ€ìƒ ê°’
      # dvo.resource_record_type ì€ "CNAME"
      name    = dvo.resource_record_name
      content = dvo.resource_record_value
      type    = dvo.resource_record_type
    }
  }

  zone_id = var.cloudflare_zone_id
  name    = each.value.name # Cloudflare providerê°€ zone_id ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬ (ì˜ˆ: _xyz.example.com. -> _xyz)
  content = each.value.content
  type    = each.value.type
  proxied = false
  ttl     = 1
}

# ACM ì¸ì¦ì„œ ê²€ì¦ ì™„ë£Œ ëŒ€ê¸°
resource "aws_acm_certificate_validation" "this" {
  certificate_arn = aws_acm_certificate.this.arn

  # ğŸ‘ˆ ìˆ˜ì •ëœ ë¶€ë¶„:
  # aws_acm_certificate ë¦¬ì†ŒìŠ¤ì˜ domain_validation_options ì—ì„œ ì§ì ‘ FQDNì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
  # ì´ ê°’ë“¤ì€ Cloudflareì— ìƒì„±ë  ë ˆì½”ë“œì˜ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
  validation_record_fqdns = [
    for dvo in aws_acm_certificate.this.domain_validation_options : dvo.resource_record_name
  ]

  # Cloudflare ë ˆì½”ë“œê°€ ìƒì„±ëœ í›„ ì´ ë¦¬ì†ŒìŠ¤ê°€ í‰ê°€ë˜ë„ë¡ ëª…ì‹œì  ì˜ì¡´ì„± ì¶”ê°€
  depends_on = [cloudflare_dns_record.validation]
}

--- END OF modules/acm/main.tf ---

--- START OF modules/acm/outputs.tf ---
# modules/acm/outputs.tf

output "certificate_arn" {
  description = "The ARN of the requested ACM certificate."
  value       = aws_acm_certificate.this.arn
}

output "validated_certificate_arn" {
  description = "The ARN of the ACM certificate after DNS validation is complete. Use this ARN for ALB listeners."
  value       = aws_acm_certificate_validation.this.certificate_arn
  # aws_acm_certificate_validation ë¦¬ì†ŒìŠ¤ëŠ” ì„±ê³µ ì‹œ ì…ë ¥ certificate_arnì„ ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
  # ì´ ì¶œë ¥ì„ ì‚¬ìš©í•˜ë©´ ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŒì„ ë³´ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
}

output "certificate_status" {
  description = "The status of the ACM certificate (e.g., PENDING_VALIDATION, ISSUED, FAILED)."
  value       = aws_acm_certificate.this.status # ê²€ì¦ ì „ ìƒíƒœë¥¼ ë³´ì—¬ì¤„ ìˆ˜ ìˆìŒ
}

--- END OF modules/acm/outputs.tf ---

--- START OF modules/acm/variables.tf ---
# modules/acm/variables.tf

variable "project_name" {
  description = "Project name (used for tagging and resource naming)."
  type        = string
}

variable "environment" {
  description = "Deployment environment (used for tagging and resource naming)."
  type        = string
}

variable "common_tags" {
  description = "Common tags to apply to all resources."
  type        = map(string)
  default     = {}
}

variable "domain_name" {
  description = "The primary domain name for the certificate (e.g., example.com)."
  type        = string
}

variable "subject_alternative_names" {
  description = "A list of Subject Alternative Names (SANs) for the certificate (e.g., [\"www.example.com\", \"api.example.com\"])."
  type        = list(string)
  default     = []
}

variable "cloudflare_zone_id" {
  description = "The Cloudflare Zone ID where the domain is managed."
  type        = string
}

--- END OF modules/acm/variables.tf ---

--- START OF modules/acm/versions.tf ---
terraform {
  required_providers {
    aws = {
      source = "hashicorp/aws"
      version = "~> 5.0"
    }
    cloudflare = {
      source = "cloudflare/cloudflare" # ğŸ‘ˆ ì˜¬ë°”ë¥¸ ì†ŒìŠ¤ ì£¼ì†Œ ëª…ì‹œ
      version = "~> 5.0" # ë£¨íŠ¸ ëª¨ë“ˆê³¼ ë™ì¼í•˜ê²Œ ë˜ëŠ” ëª¨ë“ˆì— ë§ëŠ” ë²„ì „ ì œì•½
    }
  }
}

--- END OF modules/acm/versions.tf ---

--- START OF modules/alb/main.tf ---
# modules/alb/main.tf

locals {
  module_tags = merge(var.common_tags, {
    TerraformModule = "alb"
  })

  # ë¦¬ìŠ¤ë„ˆ í¬íŠ¸ ê²°ì • (HTTPS ìš°ì„ )
  listener_port     = var.certificate_arn != null ? 443 : 80
  listener_protocol = var.certificate_arn != null ? "HTTPS" : "HTTP"
}

# 1. ALBìš© ë³´ì•ˆ ê·¸ë£¹ ìƒì„±
resource "aws_security_group" "alb_sg" {
  name        = "${var.project_name}-alb-sg-${var.environment}"
  description = "Security group for Application Load Balancer"
  vpc_id      = var.vpc_id

  # ì¸ë°”ìš´ë“œ ê·œì¹™ (ì´ì „ê³¼ ë™ì¼)
  ingress {
    description      = "Allow HTTP traffic from anywhere"
    from_port        = 80
    to_port          = 80
    protocol         = "tcp"
    cidr_blocks      = ["0.0.0.0/0"]
    ipv6_cidr_blocks = ["::/0"]
  }
  dynamic "ingress" {
    for_each = var.certificate_arn != null ? [1] : []
    content {
      description      = "Allow HTTPS traffic from anywhere"
      from_port        = 443
      to_port          = 443
      protocol         = "tcp"
      cidr_blocks      = ["0.0.0.0/0"]
      ipv6_cidr_blocks = ["::/0"]
    }
  }

  # ì•„ì›ƒë°”ìš´ë“œ ê·œì¹™: ğŸ’¥ ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½ í—ˆìš©ìœ¼ë¡œ ë³€ê²½
  egress {
    description = "Allow all outbound traffic from ALB"
    from_port   = 0
    to_port     = 0
    protocol    = "-1" # ëª¨ë“  í”„ë¡œí† ì½œ
    cidr_blocks = ["0.0.0.0/0"]
    # security_groups = [var.backend_security_group_id] # ğŸ‘ˆ ì´ ë¼ì¸ ì œê±° ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬
  }

  tags = local.module_tags
}

# 2. Application Load Balancer (ALB) ìƒì„±
resource "aws_lb" "main" {
  name               = "${var.project_name}-alb-${var.environment}"
  internal           = var.alb_is_internal
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb_sg.id]
  subnets            = var.public_subnet_ids # í¼ë¸”ë¦­ ì„œë¸Œë„· ID ëª©ë¡

  # ì‚­ì œ ë³´í˜¸ ë¹„í™œì„±í™” (ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì— ì í•©)
  enable_deletion_protection = false

  # ì ‘ê·¼ ë¡œê·¸ ì„¤ì • (ì„ íƒ ì‚¬í•­, í•„ìš”ì‹œ S3 ë²„í‚· ìƒì„± í›„ ì„¤ì •)
  # access_logs {
  #   bucket  = "your-alb-logs-s3-bucket-name"
  #   prefix  = "${var.project_name}-alb"
  #   enabled = true
  # }

  tags = local.module_tags
}

# 3. ëŒ€ìƒ ê·¸ë£¹ (Target Group) ìƒì„±
resource "aws_lb_target_group" "main" {
  name        = "${var.project_name}-${var.environment}-tg" # ğŸ‘ˆ 'name' ì†ì„± ì‚¬ìš©
  port        = var.backend_app_port                        # ë°±ì—”ë“œ ì¸ìŠ¤í„´ìŠ¤ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸
  protocol    = "HTTP"                                      # ALB -> ë°±ì—”ë“œ í†µì‹  í”„ë¡œí† ì½œ
  vpc_id      = var.vpc_id
  target_type = "instance" # EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨

  health_check {
    enabled             = true
    path                = var.health_check_path
    port                = var.health_check_port
    protocol            = var.health_check_protocol
    matcher             = "200-399" # HTTP ì‘ë‹µ ì½”ë“œ 200-399ë¥¼ ì •ìƒìœ¼ë¡œ ê°„ì£¼
    interval            = 10
    timeout             = 5
    healthy_threshold   = 2
    unhealthy_threshold = 2
  }

  # ëŒ€ìƒ ê·¸ë£¹ì— ì§ì ‘ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë“±ë¡í•˜ì§€ ì•Šê³ , Auto Scaling Groupì—ì„œ ì´ ëŒ€ìƒ ê·¸ë£¹ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•  ì˜ˆì •
  # ë”°ë¼ì„œ targets ë¸”ë¡ì€ ë¹„ì›Œë‘¡ë‹ˆë‹¤.

  tags = local.module_tags
}

# 4. HTTP ë¦¬ìŠ¤ë„ˆ ìƒì„±
# ì´ ë¦¬ìŠ¤ë„ˆëŠ” í•­ìƒ ìƒì„±ë©ë‹ˆë‹¤.
# - ACM ì¸ì¦ì„œê°€ ìˆìœ¼ë©´: ëª¨ë“  HTTP íŠ¸ë˜í”½ì„ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜í•©ë‹ˆë‹¤.
# - ACM ì¸ì¦ì„œê°€ ì—†ìœ¼ë©´: HTTP íŠ¸ë˜í”½ì„ ëŒ€ìƒ ê·¸ë£¹ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
resource "aws_lb_listener" "http" {
  load_balancer_arn = aws_lb.main.arn
  port              = 80
  protocol          = "HTTP"

  default_action {
    // create_https_listener ê°’ì— ë”°ë¼ typeê³¼ target_group_arn ê²°ì •
    type = var.create_https_listener ? "redirect" : "forward"

    // create_https_listenerê°€ true (ë¦¬ë””ë ‰ì…˜) ì´ë©´ target_group_arnì€ null
    // false (í¬ì›Œë“œ) ì´ë©´ target_group_arn ì„¤ì •
    target_group_arn = var.create_https_listener ? null : aws_lb_target_group.main.arn

    // create_https_listenerê°€ trueì¼ ë•Œë§Œ redirect ë¸”ë¡ ë‚´ìš©ì´ í¬í•¨ë¨
    dynamic "redirect" {
      for_each = var.create_https_listener ? { "https_redirect" = true } : {}
      content {
        port        = "443"
        protocol    = "HTTPS"
        status_code = "HTTP_301"
      }
    }
  }
}

# 5. HTTPS ë¦¬ìŠ¤ë„ˆ ìƒì„± (ACM ì¸ì¦ì„œê°€ ì œê³µëœ ê²½ìš°)
resource "aws_lb_listener" "https" {
  # var.create_https_listenerëŠ” ë£¨íŠ¸ì—ì„œ domain_name ì¡´ì¬ ì—¬ë¶€ ë“±ìœ¼ë¡œ ê²°ì •
  count = var.create_https_listener ? 1 : 0

  load_balancer_arn = aws_lb.main.arn
  port              = 443
  protocol          = "HTTPS"
  ssl_policy        = "ELBSecurityPolicy-2016-08"
  # certificate_arnì€ countê°€ 1ì¼ ë•Œ ìœ íš¨í•œ ê°’ì´ ì „ë‹¬ë  ê²ƒìœ¼ë¡œ ê¸°ëŒ€
  certificate_arn = var.certificate_arn

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.main.arn
  }
}

--- END OF modules/alb/main.tf ---

--- START OF modules/alb/outputs.tf ---
# modules/alb/outputs.tf

output "alb_dns_name" {
  description = "ìƒì„±ëœ Application Load Balancerì˜ DNS ì´ë¦„"
  value       = aws_lb.main.dns_name
}

output "alb_zone_id" {
  description = "ìƒì„±ëœ Application Load Balancerì˜ Canonical Hosted Zone ID (Route 53 ë³„ì¹­ ë ˆì½”ë“œìš©)"
  value       = aws_lb.main.zone_id
}

output "alb_arn" {
  description = "ìƒì„±ëœ Application Load Balancerì˜ ARN"
  value       = aws_lb.main.arn
}

output "http_listener_arn" {
  description = "HTTP ë¦¬ìŠ¤ë„ˆì˜ ARN"
  # ë‹¨ì¼ ë¦¬ì†ŒìŠ¤ì´ë¯€ë¡œ ì¸ë±ìŠ¤([0]) ì—†ì´ ì§ì ‘ .arn ì†ì„± ì°¸ì¡°
  value = aws_lb_listener.http.arn
}

output "https_listener_arn" {
  description = "HTTPS ë¦¬ìŠ¤ë„ˆì˜ ARN (ìƒì„±ëœ ê²½ìš°)"
  value       = length(aws_lb_listener.https) > 0 ? aws_lb_listener.https[0].arn : null
}

output "target_group_arn" {
  description = "ìƒì„±ëœ ëŒ€ìƒ ê·¸ë£¹ì˜ ARN (Auto Scaling Groupì— ì—°ê²° ì‹œ í•„ìš”)"
  value       = aws_lb_target_group.main.arn
}

output "target_group_name" {
  description = "ìƒì„±ëœ ëŒ€ìƒ ê·¸ë£¹ì˜ ì´ë¦„"
  value       = aws_lb_target_group.main.name
}

output "security_group_id" {
  description = "ALBì— ì—°ê²°ëœ ë³´ì•ˆ ê·¸ë£¹ì˜ ID"
  value       = aws_security_group.alb_sg.id
}

--- END OF modules/alb/outputs.tf ---

--- START OF modules/alb/variables.tf ---
# modules/alb/variables.tf

variable "project_name" {
  description = "í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "environment" {
  description = "ë°°í¬ í™˜ê²½ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "common_tags" {
  description = "ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë  íƒœê·¸"
  type        = map(string)
  default     = {}
}

variable "vpc_id" {
  description = "ALB ë° ê´€ë ¨ ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë  VPC ID"
  type        = string
}

variable "public_subnet_ids" {
  description = "ALBë¥¼ ë°°í¬í•  í¼ë¸”ë¦­ ì„œë¸Œë„· ID ëª©ë¡ (ìµœì†Œ 2ê°œ AZì˜ ì„œë¸Œë„· ê¶Œì¥)"
  type        = list(string)
  # í˜„ì¬ ì €í¬ êµ¬ì„±ì—ì„œëŠ” ë‹¨ì¼ í¼ë¸”ë¦­ ì„œë¸Œë„·ë§Œ ì‚¬ìš© ì¤‘ì´ì§€ë§Œ, ALBëŠ” ë³´í†µ 2ê°œ ì´ìƒì˜ AZì— ê±¸ì³ êµ¬ì„±ë©ë‹ˆë‹¤.
  # ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ [module.vpc.public_subnet_id] ì™€ ê°™ì´ ë‹¨ì¼ IDë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì „ë‹¬í•  ì˜ˆì •ì…ë‹ˆë‹¤.
}

variable "alb_is_internal" {
  description = "ALBë¥¼ ë‚´ë¶€ìš©(internal)ìœ¼ë¡œ ìƒì„±í• ì§€ ì—¬ë¶€ (falseë©´ ì¸í„°ë„· ì—°ê²°)"
  type        = bool
  default     = false # ê¸°ë³¸ê°’: ì¸í„°ë„· ì—°ê²° ALB
}

variable "backend_app_port" {
  description = "ë°±ì—”ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ (ëŒ€ìƒ ê·¸ë£¹ì´ íŠ¸ë˜í”½ì„ ì „ë‹¬í•  í¬íŠ¸)"
  type        = number
  default     = 80 # ì´ì „ ec2_backend ëª¨ë“ˆì˜ user_data.shì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ 80ë²ˆ í¬íŠ¸ë¡œ ë§¤í•‘í•¨
}

variable "health_check_path" {
  description = "ëŒ€ìƒ ê·¸ë£¹ í—¬ìŠ¤ ì²´í¬ ê²½ë¡œ"
  type        = string
  default     = "/" # FastAPI ë£¨íŠ¸ ê²½ë¡œ ë˜ëŠ” ë³„ë„ í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
}

variable "health_check_port" {
  description = "ëŒ€ìƒ ê·¸ë£¹ í—¬ìŠ¤ ì²´í¬ í¬íŠ¸ ('traffic-port' ë˜ëŠ” íŠ¹ì • í¬íŠ¸)"
  type        = string
  default     = "traffic-port" # íŠ¸ë˜í”½ì„ ë°›ëŠ” í¬íŠ¸ì™€ ë™ì¼í•˜ê²Œ ì‚¬ìš©
}

variable "health_check_protocol" {
  description = "ëŒ€ìƒ ê·¸ë£¹ í—¬ìŠ¤ ì²´í¬ í”„ë¡œí† ì½œ"
  type        = string
  default     = "HTTP"
}

variable "create_https_listener" {
  description = "Flag to determine if the HTTPS listener should be created. Set to false if no certificate_arn is provided or HTTPS is not needed."
  type        = bool
  default     = true # ê¸°ë³¸ì ìœ¼ë¡œ ìƒì„± ì‹œë„, ë£¨íŠ¸ì—ì„œ ì œì–´
}

variable "certificate_arn" {
  description = "HTTPS ë¦¬ìŠ¤ë„ˆì— ì‚¬ìš©í•  ACM ì¸ì¦ì„œ ARN (ì œê³µë˜ì§€ ì•Šìœ¼ë©´ HTTP ë¦¬ìŠ¤ë„ˆë§Œ ìƒì„±)"
  type        = string
  default     = null
}

--- END OF modules/alb/variables.tf ---

--- START OF modules/ec2_backend/main.tf ---
# modules/ec2_backend/main.tf

locals {
  module_tags = merge(var.common_tags, {
    TerraformModule = "ec2-backend"
  })

  # User Data ë Œë”ë§ ì‹œ ì‚¬ìš©í•  ë³€ìˆ˜ ë§µ (í”Œë ˆì´ìŠ¤í™€ë” ì´ë¦„ ë³€ê²½ ë° host_app_port ì¶”ê°€)
  user_data_template_vars = {
    fastapi_docker_image_placeholder    = var.fastapi_docker_image # ğŸ‘ˆ ëª¨ë“ˆ ì…ë ¥ ë³€ìˆ˜(var.fastapi_docker_image)ë¥¼ í”Œë ˆì´ìŠ¤í™€ë” ì´ë¦„ìœ¼ë¡œ ë§¤í•‘
    container_internal_port_placeholder = var.fastapi_app_port     # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸
    host_exposed_port_placeholder       = var.host_app_port        # í˜¸ìŠ¤íŠ¸ì— ë…¸ì¶œë  í¬íŠ¸
    aws_region_placeholder              = var.aws_region

    database_url_placeholder      = var.fastapi_database_url
    secret_key_placeholder        = var.fastapi_secret_key
    firebase_b64_json_placeholder = var.firebase_b64_json
  }
}

# 1. IAM ì—­í•  ë° ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ ìƒì„± (EC2 ì¸ìŠ¤í„´ìŠ¤ìš©)
resource "aws_iam_role" "ec2_backend_role" {
  name = "${var.project_name}-ec2-backend-role-${var.environment}"
  assume_role_policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Action = "sts:AssumeRole",
        Effect = "Allow",
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })

  tags = local.module_tags
}

# ğŸ¯ ECR ì½ê¸° ì „ìš© ê¶Œí•œ ì •ì±… ì—°ê²° ì¶”ê°€
resource "aws_iam_role_policy_attachment" "ec2_backend_ecr_ro" {
  role       = aws_iam_role.ec2_backend_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
}

# EC2 ì¸ìŠ¤í„´ìŠ¤ì— SSM ì ‘ê·¼ ë° CloudWatch Logs ê¸°ë³¸ ê¶Œí•œì„ ìœ„í•œ ì •ì±… ì—°ê²° (ì„ íƒ ì‚¬í•­)
resource "aws_iam_role_policy_attachment" "ssm_policy" {
  role       = aws_iam_role.ec2_backend_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
}

# CloudWatch Agent ì‚¬ìš© ê³„íšì´ ìˆë‹¤ë©´ ì•„ë˜ ì •ì±…ë„ ì—°ê²° ê°€ëŠ¥
# resource "aws_iam_role_policy_attachment" "cloudwatch_agent_policy" {
#   role       = aws_iam_role.ec2_backend_role.name
#   policy_arn = "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
# }

resource "aws_iam_instance_profile" "ec2_backend_profile" {
  name = "${var.project_name}-ec2-backend-profile-${var.environment}"
  role = aws_iam_role.ec2_backend_role.name

  tags = local.module_tags
}

# 2. EC2 ë°±ì—”ë“œ ì¸ìŠ¤í„´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹
resource "aws_security_group" "ec2_backend_sg" {
  name        = "${var.project_name}-ec2-backend-sg-${var.environment}"
  description = "Security group for EC2 backend instances"
  vpc_id      = var.vpc_id

  # ì¸ë°”ìš´ë“œ ê·œì¹™:
  # ğŸ’¥ ì¤‘ìš”: ALBë¡œë¶€í„°ì˜ íŠ¸ë˜í”½ í—ˆìš© ê·œì¹™ì€ ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ aws_security_group_ruleì„ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€í•©ë‹ˆë‹¤.
  ingress {
    description = "Allow HTTP traffic on app port from within VPC (placeholder for ALB)"
    from_port   = var.host_app_port
    to_port     = var.host_app_port
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }


  # ì•„ì›ƒë°”ìš´ë“œ ê·œì¹™: ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½ í—ˆìš© (NAT ì¸ìŠ¤í„´ìŠ¤ë¥¼ í†µí•´ ì¸í„°ë„· ì ‘ê·¼)
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = local.module_tags
}

# 3. ì‹œì‘ í…œí”Œë¦¿ (Launch Template) ìƒì„±
resource "aws_launch_template" "ec2_backend_lt" {
  name_prefix   = "${var.project_name}-backend-lt-${var.environment}-"
  image_id      = var.ami_id
  instance_type = var.instance_type

  iam_instance_profile {
    arn = aws_iam_instance_profile.ec2_backend_profile.arn
  }

  network_interfaces {
    associate_public_ip_address = false # í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ë°°í¬
    security_groups             = [aws_security_group.ec2_backend_sg.id]
    # delete_on_termination = true # ê¸°ë³¸ê°’ true
  }

  # User Data ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ë Œë”ë§ ë° Base64 ì¸ì½”ë”©
  user_data = base64encode(templatefile("${path.module}/user_data.sh", local.user_data_template_vars))

  # ì¸ìŠ¤í„´ìŠ¤ì— ì ìš©ë  íƒœê·¸
  tag_specifications {
    resource_type = "instance"
    tags = merge(local.module_tags, {
      Name = "${var.project_name}-backend-instance-${var.environment}"
    })
  }
  tag_specifications {
    resource_type = "volume"
    tags = merge(local.module_tags, {
      Name = "${var.project_name}-backend-volume-${var.environment}"
    })
  }

  # Metadata ì˜µì…˜ (IMDSv2 ê¶Œì¥)
  metadata_options {
    http_endpoint               = "enabled"
    http_tokens                 = "required" # IMDSv2 ì‚¬ìš©
    http_put_response_hop_limit = 1
  }

  # ê¸°ë³¸ì ìœ¼ë¡œ ìµœì‹  ë²„ì „ì˜ ì‹œì‘ í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
  # update_default_version = true # í•„ìš”ì— ë”°ë¼ ì‚¬ìš©
  # default_version = version # íŠ¹ì • ë²„ì „ì„ ê¸°ë³¸ìœ¼ë¡œ ì§€ì •í•  ë•Œ

  lifecycle {
    create_before_destroy = true
  }

  tags = local.module_tags
}

# 4. Auto Scaling Group (ASG) ìƒì„±
resource "aws_autoscaling_group" "ec2_backend_asg" {
  name_prefix = "${var.project_name}-backend-asg-${var.environment}-"

  launch_template {
    id      = aws_launch_template.ec2_backend_lt.id
    version = aws_launch_template.ec2_backend_lt.latest_version # ğŸ‘ˆ í•­ìƒ ìµœì‹  ë²„ì „ì˜ ì‹œì‘ í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
  }

  min_size                  = var.asg_min_size
  max_size                  = var.asg_max_size
  desired_capacity          = var.asg_desired_capacity
  vpc_zone_identifier       = var.private_app_subnet_ids
  health_check_type         = var.health_check_type
  health_check_grace_period = var.health_check_grace_period
  target_group_arns         = var.target_group_arns

  # ğŸ¯ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ (Instance Refresh) ì„¤ì • ì¶”ê°€ ë˜ëŠ” í™•ì¸
  instance_refresh {
    strategy = "Rolling" # ì ì§„ì  êµì²´ ë°©ì‹ (ë‹¤ë¥¸ ì˜µì…˜: "Replace")
    preferences {
      # ìƒˆë¡œ ê³ ì¹¨ ì¤‘ ìœ ì§€í•´ì•¼ í•  ìµœì†Œ ì •ìƒ ì¸ìŠ¤í„´ìŠ¤ ë¹„ìœ¨.
      # ì˜ˆ: 100%ë¡œ ì„¤ì •í•˜ë©´, ìƒˆ ì¸ìŠ¤í„´ìŠ¤ê°€ ì •ìƒí™”ëœ í›„ ì´ì „ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¢…ë£Œ (ë” ì•ˆì „í•˜ì§€ë§Œ ëŠë¦¼)
      # ì˜ˆ: 90%ë¡œ ì„¤ì •í•˜ë©´, ì „ì²´ ìš©ëŸ‰ì˜ 10%ê¹Œì§€ë§Œ ë™ì‹œì— êµì²´ ì§„í–‰ ê°€ëŠ¥
      min_healthy_percentage = var.asg_min_healthy_percentage

      # ìƒˆ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹œì‘ëœ í›„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™„ì „íˆ ì¤€ë¹„ë˜ê³  í—¬ìŠ¤ ì²´í¬ë¥¼ í†µê³¼í•  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ëŠ” ì‹œê°„(ì´ˆ).
      # ì´ ì‹œê°„ ë™ì•ˆì—ëŠ” min_healthy_percentage ê³„ì‚°ì— í¬í•¨ë˜ì§€ ì•Šê±°ë‚˜, í—¬ìŠ¤ ì²´í¬ë¥¼ ìœ ì˜ˆí•©ë‹ˆë‹¤.
      instance_warmup = var.asg_instance_warmup

      # ìƒˆë¡œ ê³ ì¹¨ì„ íŠ¹ì • ë¹„ìœ¨ì—ì„œ ì¼ì‹œ ì¤‘ì§€í•˜ê³  ëŒ€ê¸°í•  ìˆ˜ ìˆëŠ” ì²´í¬í¬ì¸íŠ¸ ì„¤ì • (ì„ íƒ ì‚¬í•­)
      # checkpoint_percentages = [33, 66, 100]
      # checkpoint_delay       = "PT5M" # ê° ì²´í¬í¬ì¸íŠ¸ì—ì„œ 5ë¶„ ëŒ€ê¸° (ISO 8601 duration format)

      # ê¸°íƒ€ ê³ ê¸‰ ì„¤ì •:
      # scale_in_protected_instances = "Refresh" # ì¶•ì†Œ ë°©ì§€ëœ ì¸ìŠ¤í„´ìŠ¤ë„ ìƒˆë¡œê³ ì¹¨ì— í¬í•¨í• ì§€ ì—¬ë¶€
      # standby_instances            = "Terminate" # ëŒ€ê¸° ìƒíƒœ ì¸ìŠ¤í„´ìŠ¤ ì²˜ë¦¬ ë°©ë²•
    }
    # ì–´ë–¤ ë³€ê²½ì´ ìˆì„ ë•Œ ìƒˆë¡œ ê³ ì¹¨ì„ íŠ¸ë¦¬ê±°í• ì§€ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    # ì‹œì‘ í…œí”Œë¦¿ ë²„ì „ ë³€ê²½ì€ ASGê°€ launch_template.version = "$Latest" ë˜ëŠ” .latest_version ì„ ì‚¬ìš©í•  ë•Œ
    # ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ì—…ë°ì´íŠ¸ë¥¼ ì‹œë„í•˜ëŠ” ê²½í–¥ì´ ìˆì§€ë§Œ, ëª…ì‹œì ì¸ íŠ¸ë¦¬ê±°ë¥¼ ì„¤ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
    # ì˜ˆë¥¼ ë“¤ì–´, ASGì˜ íŠ¹ì • íƒœê·¸ ê°’ì´ ë³€ê²½ë  ë•Œ ìƒˆë¡œê³ ì¹¨ì„ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    # triggers = ["tag"] # ì˜ˆì‹œ: íƒœê·¸ ë³€ê²½ ì‹œ ìƒˆë¡œê³ ì¹¨ (ì´ ê²½ìš° ê´€ë ¨ íƒœê·¸ë„ ê´€ë¦¬í•´ì•¼ í•¨)
    # í˜„ì¬ëŠ” launch_templateì˜ version ë³€ê²½ì„ ì£¼ëœ íŠ¸ë¦¬ê±°ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
    # triggers = ["launch_template"] ê¸°ë³¸ê°’ì´ë¯€ë¡œ êµ³ì´ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤.
  }

  # ASGê°€ ìƒì„±í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ìë™ìœ¼ë¡œ íƒœê·¸ ì „íŒŒ
  dynamic "tag" {
    for_each = merge(local.module_tags, {
      Name                 = "${var.project_name}-backend-instance-${var.environment}"
      "AmazonEC2CreatedBy" = "TerraformASG"
    })
    content {
      key                 = tag.key
      value               = tag.value
      propagate_at_launch = true
    }
  }

  lifecycle {
    create_before_destroy = true
  }
}

--- END OF modules/ec2_backend/main.tf ---

--- START OF modules/ec2_backend/outputs.tf ---
# modules/ec2_backend/outputs.tf

output "asg_name" {
  description = "ìƒì„±ëœ Auto Scaling Groupì˜ ì´ë¦„"
  value       = aws_autoscaling_group.ec2_backend_asg.name
}

output "asg_arn" {
  description = "ìƒì„±ëœ Auto Scaling Groupì˜ ARN"
  value       = aws_autoscaling_group.ec2_backend_asg.arn
}

output "launch_template_id" {
  description = "ìƒì„±ëœ ì‹œì‘ í…œí”Œë¦¿ì˜ ID"
  value       = aws_launch_template.ec2_backend_lt.id
}

output "launch_template_latest_version" {
  description = "ìƒì„±ëœ ì‹œì‘ í…œí”Œë¦¿ì˜ ìµœì‹  ë²„ì „ ë²ˆí˜¸"
  value       = aws_launch_template.ec2_backend_lt.latest_version
}

output "security_group_id" {
  description = "EC2 ë°±ì—”ë“œ ì¸ìŠ¤í„´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹ ID (ALB ì„¤ì • ì‹œ í•„ìš”)"
  value       = aws_security_group.ec2_backend_sg.id
}

output "iam_role_arn" {
  description = "EC2 ë°±ì—”ë“œ ì¸ìŠ¤í„´ìŠ¤ìš© IAM ì—­í• ì˜ ARN"
  value       = aws_iam_role.ec2_backend_role.arn
}

output "iam_instance_profile_arn" {
  description = "EC2 ë°±ì—”ë“œ ì¸ìŠ¤í„´ìŠ¤ìš© IAM ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ì˜ ARN"
  value       = aws_iam_instance_profile.ec2_backend_profile.arn
}

--- END OF modules/ec2_backend/outputs.tf ---

--- START OF modules/ec2_backend/user_data.sh ---
#!/bin/bash
# modules/ec2_backend/user_data.sh (Corrected Final Version)

exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
set -e

echo "--- $(date) --- Starting EC2 User Data Script ---"

# Terraform templatefileì„ í†µí•´ ì „ë‹¬ë  ë³€ìˆ˜ë“¤
FASTAPI_IMAGE_URI="${fastapi_docker_image_placeholder}"
HOST_EXPOSED_PORT="${host_exposed_port_placeholder}"
CONTAINER_INTERNAL_PORT="${container_internal_port_placeholder}"
AWS_REGION="${aws_region_placeholder}"
DATABASE_URL="${database_url_placeholder}"
SECRET_KEY="${secret_key_placeholder}"
FIREBASE_B64_JSON="${firebase_b64_json_placeholder}"

# ... (Docker ì„¤ì¹˜ ë° ECR ë¡œê·¸ì¸ ë¡œì§ì€ ë™ì¼) ...
echo "Installing Docker..."
sudo yum update -y -q
sudo amazon-linux-extras install docker -y -q
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

echo "Waiting for Docker daemon..."
# ... (Docker ë°ëª¬ ëŒ€ê¸° ë¡œì§) ...

if [[ "$FASTAPI_IMAGE_URI" == *".dkr.ecr."* ]]; then
  echo "ECR image detected. Logging in to ECR..."
  # ... (ECR ë¡œê·¸ì¸ ë¡œì§) ...
fi

echo "Pulling Docker image: $FASTAPI_IMAGE_URI ..."
sudo docker pull "$FASTAPI_IMAGE_URI"

# 5. Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (í™˜ê²½ ë³€ìˆ˜ ì£¼ì… ë° ì˜ˆì™¸ ì²˜ë¦¬ í¬í•¨)
echo "Running Docker container with environment variables..."
CONTAINER_NAME="fastapi_app_container"
if [ "$(sudo docker ps -aq -f name=$CONTAINER_NAME)" ]; then
    echo "Attempting to remove existing container: $CONTAINER_NAME"
    sudo docker rm -f $CONTAINER_NAME
fi

# ğŸ’¡ docker run ëª…ë ¹ì–´
if ! sudo docker run -d --name $CONTAINER_NAME --restart always \
  -p "$HOST_EXPOSED_PORT":"$CONTAINER_INTERNAL_PORT" \
  -e APP_ENV="prod" \
  -e DATABASE_URL="$DATABASE_URL" \
  -e SECRET_KEY="$SECRET_KEY" \
  -e FIREBASE_SERVICE_ACCOUNT_KEY_PATH="/tmp/firebase_service_account.json" \
  -e FIREBASE_SERVICE_ACCOUNT_KEY_JSON_BASE64="$FIREBASE_B64_JSON" \
  "$FASTAPI_IMAGE_URI"; then
  
  # docker run ëª…ë ¹ ìì²´ê°€ ì‹¤íŒ¨í•œ ê²½ìš°
  echo "::error:: 'docker run' command failed to start the container initially."
  exit 1
fi

# ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ì€ ë˜ì—ˆì§€ë§Œ, ë°”ë¡œ ì¢…ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§
echo "Container start command issued. Verifying status in 10 seconds..."
sleep 10
RUNNING_CONTAINER_ID=$(sudo docker ps -q --filter "name=$CONTAINER_NAME" --filter "status=running")

if [ -z "$RUNNING_CONTAINER_ID" ]; then
  echo "::error:: Container is not in 'running' state after start attempt."
  EXITED_CONTAINER_ID=$(sudo docker ps -a --filter "name=$CONTAINER_NAME" --filter "status=exited" --format "{{.ID}}" | head -n 1)
  
  if [ -n "$EXITED_CONTAINER_ID" ]; then
    echo "Logs from recently exited container $EXITED_CONTAINER_ID:"
    sudo docker logs "$EXITED_CONTAINER_ID"
  else
    echo "Could not find a recently exited container with the name $CONTAINER_NAME."
  fi
  exit 1
fi

echo "âœ… Docker container $CONTAINER_NAME (ID: $RUNNING_CONTAINER_ID) is confirmed to be running."
echo "--- $(date) --- EC2 User Data Script Finished Successfully ---"
--- END OF modules/ec2_backend/user_data.sh ---

--- START OF modules/ec2_backend/variables.tf ---
# modules/ec2_backend/variables.tf

variable "project_name" {
  description = "í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "aws_region" {
  description = "AWS ë¦¬ì „ (ECR ë¡œê·¸ì¸ ë“±ì— ì‚¬ìš©)"
  type        = string
}

variable "environment" {
  description = "ë°°í¬ í™˜ê²½ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "common_tags" {
  description = "ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë  íƒœê·¸"
  type        = map(string)
  default     = {}
}

variable "vpc_id" {
  description = "EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ë³´ì•ˆ ê·¸ë£¹ì´ ìƒì„±ë  VPC ID"
  type        = string
}

variable "private_app_subnet_ids" {
  description = "EC2 ì¸ìŠ¤í„´ìŠ¤(ASG)ë¥¼ ë°°í¬í•  í”„ë¼ì´ë¹— ì•± ì„œë¸Œë„· ID ëª©ë¡"
  type        = list(string) # ì—¬ëŸ¬ AZì— ê±¸ì³ ë°°í¬í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ listë¡œ ë°›ìŒ (í˜„ì¬ëŠ” ë‹¨ì¼ AZ)
}

variable "instance_type" {
  description = "EC2 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•"
  type        = string
  default     = "t2.micro" # í”„ë¦¬í‹°ì–´
}

variable "ami_id" {
  description = "EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì‚¬ìš©í•  AMI ID (Amazon Linux 2 ê¶Œì¥)"
  type        = string
  # ì´ ê°’ì€ ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ data.aws_amië¥¼ í†µí•´ ë™ì ìœ¼ë¡œ ê°€ì ¸ì™€ ì „ë‹¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
}

# Auto Scaling Group (ASG) ê´€ë ¨ ë³€ìˆ˜
variable "asg_min_size" {
  description = "ASGì˜ ìµœì†Œ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜"
  type        = number
  default     = 1
}

variable "asg_max_size" {
  description = "ASGì˜ ìµœëŒ€ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜"
  type        = number
  default     = 2 # í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 2ë¡œ ì„¤ì •, í•„ìš”ì‹œ ì¡°ì •
}

variable "asg_desired_capacity" {
  description = "ASGì˜ ì›í•˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ ìˆ˜"
  type        = number
  default     = 1
}

variable "health_check_type" {
  description = "ASG í—¬ìŠ¤ ì²´í¬ ìœ í˜• (EC2 ë˜ëŠ” ELB)"
  type        = string
  default     = "ELB"
}

variable "asg_instance_warmup" {
  description = "ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ ì‹œ ìƒˆ ì¸ìŠ¤í„´ìŠ¤ê°€ ì„œë¹„ìŠ¤ì— íˆ¬ì…ë˜ê¸° ì „ ì¤€ë¹„ ì‹œê°„ (ì´ˆ)"
  type        = number
  default     = 30
}

variable "asg_min_healthy_percentage" {
  description = "ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ ì¤‘ ìœ ì§€ë˜ì–´ì•¼ í•˜ëŠ” ìµœì†Œ ì •ìƒ ì¸ìŠ¤í„´ìŠ¤ ë¹„ìœ¨ (%)"
  type        = number
  default     = 90 # ì˜ˆ: 90%. ê°€ìš©ì„±ì„ ìœ„í•´ ì ì ˆíˆ ì¡°ì ˆ
}

# (ì„ íƒ ì‚¬í•­) ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ ì²´í¬í¬ì¸íŠ¸ ê´€ë ¨ ë³€ìˆ˜ (ê¸°ë³¸ê°’ì€ nullë¡œ ì‚¬ìš© ì•ˆ í•¨)
variable "asg_refresh_checkpoint_percentages" {
  description = "ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ê³ ì¹¨ì„ ì¼ì‹œ ì¤‘ì§€í•  ì²´í¬í¬ì¸íŠ¸ ë¹„ìœ¨ ëª©ë¡ (ì˜ˆ: [30, 60, 100])"
  type        = list(number)
  default     = null
}

variable "asg_refresh_checkpoint_delay" {
  description = "ê° ì²´í¬í¬ì¸íŠ¸ì—ì„œ ëŒ€ê¸°í•  ì‹œê°„ (ISO 8601 ê¸°ê°„ í˜•ì‹, ì˜ˆ: PT5M = 5ë¶„)"
  type        = string
  default     = null
}

variable "health_check_grace_period" {
  description = "ìƒˆ ì¸ìŠ¤í„´ìŠ¤ ì‹œì‘ í›„ í—¬ìŠ¤ ì²´í¬ ìœ ì˜ˆ ê¸°ê°„(ì´ˆ)"
  type        = number
  default     = 60
}

# Docker ë° FastAPI ê´€ë ¨ ë³€ìˆ˜
variable "fastapi_docker_image" {
  description = "ì‹¤í–‰í•  FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ Docker ì´ë¯¸ì§€ (ì˜ˆ: your-account/your-repo:latest)"
  type        = string
}

variable "fastapi_app_port" {
  description = "FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” í¬íŠ¸"
  type        = number
  default     = 80 # ìœ„ ì˜ˆì œ ì´ë¯¸ì§€ëŠ” 80 í¬íŠ¸ì—ì„œ ì‹¤í–‰ë¨
}

variable "host_app_port" { # ğŸ‘ˆ ìƒˆë¡œ ì¶”ê°€: ì»¨í…Œì´ë„ˆë¥¼ í˜¸ìŠ¤íŠ¸ì— ë…¸ì¶œí•  í¬íŠ¸
  description = "EC2 í˜¸ìŠ¤íŠ¸ì—ì„œ Docker ì»¨í…Œì´ë„ˆì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë…¸ì¶œí•  í¬íŠ¸ (ALBê°€ ì´ í¬íŠ¸ë¥¼ íƒ€ê²Ÿ)"
  type        = number
  default     = 80
}

variable "my_ip_for_ssh" {
  description = "EC2 ì¸ìŠ¤í„´ìŠ¤ì— SSH ì ‘ê·¼ì„ í—ˆìš©í•  ë‚˜ì˜ IP ì£¼ì†Œ (CIDR í˜•íƒœ, ë””ë²„ê¹…ìš©)"
  type        = string
  default     = "0.0.0.0/0" # â˜¢ï¸ ë³´ì•ˆ ê²½ê³ : ì‹¤ì œ IPë¡œ ë³€ê²½ ê¶Œì¥!
}

variable "target_group_arns" {
  description = "EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë“±ë¡í•  ALB ëŒ€ìƒ ê·¸ë£¹ ARN ëª©ë¡"
  type        = list(string)
  default     = [] # ê¸°ë³¸ê°’ì€ ë¹ˆ ë¦¬ìŠ¤íŠ¸
}

variable "backend_app_port" {
  description = "ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ (ALB ëŒ€ìƒ ê·¸ë£¹ ë° ë³´ì•ˆ ê·¸ë£¹ ê·œì¹™ì— ì‚¬ìš©)"
  type        = number
  default     = 80 # ec2_backend ëª¨ë“ˆì˜ user_data.sh ì—ì„œ í˜¸ìŠ¤íŠ¸ì˜ 80 í¬íŠ¸ë¡œ ë§¤í•‘í–ˆìŒ
}

variable "fastapi_database_url" {
  description = "FastAPIê°€ ì‚¬ìš©í•  ì „ì²´ DATABASE_URL"
  type        = string
  sensitive   = true # DB ì—°ê²° ì •ë³´ëŠ” ë¯¼ê° ì •ë³´ì´ë¯€ë¡œ ì¶œë ¥ì— ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ í•¨
}

variable "fastapi_secret_key" {
  description = "FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ JWT ì‹œí¬ë¦¿ í‚¤"
  type        = string
  sensitive   = true # ì‹œí¬ë¦¿ í‚¤ëŠ” ë¯¼ê° ì •ë³´
}

variable "firebase_b64_json" {
  description = "Base64ë¡œ ì¸ì½”ë”©ëœ Firebase ì„œë¹„ìŠ¤ ê³„ì • JSON"
  type        = string
  sensitive   = true # ì„œë¹„ìŠ¤ ê³„ì • í‚¤ëŠ” ë¯¼ê° ì •ë³´
}

--- END OF modules/ec2_backend/variables.tf ---

--- START OF modules/nat_instance/main.tf ---
# modules/nat_instance/main.tf

locals {
  module_tags = merge(var.common_tags, {
    TerraformModule = "nat-instance"
  })
}

# ğŸ¯ 1. NAT ì¸ìŠ¤í„´ìŠ¤ìš© IAM ì—­í•  ë° ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ ìƒì„± (SSM ì ‘ê·¼ìš©)
resource "aws_iam_role" "nat_instance_role" {
  name = "${var.project_name}-nat-instance-role-${var.environment}"
  assume_role_policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Action = "sts:AssumeRole",
        Effect = "Allow",
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })
  tags = local.module_tags
}

resource "aws_iam_role_policy_attachment" "nat_ssm_policy" {
  role       = aws_iam_role.nat_instance_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore" # SSM Agent ì‘ë™ì— í•„ìš”í•œ ê¸°ë³¸ ê¶Œí•œ
}

resource "aws_iam_role_policy_attachment" "nat_ecr_ro_policy" {
  role       = aws_iam_role.nat_instance_role.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
}

resource "aws_iam_instance_profile" "nat_instance_profile" {
  name = "${var.project_name}-nat-instance-profile-${var.environment}"
  role = aws_iam_role.nat_instance_role.name
  tags = local.module_tags
}

# NAT ì¸ìŠ¤í„´ìŠ¤ìš© ìµœì‹  Amazon Linux 2 AMI ì¡°íšŒ (ê¸°ì¡´ê³¼ ë™ì¼)
data "aws_ami" "nat_ami" {
  most_recent = true
  owners      = [var.nat_instance_ami_owner]
  filter {
    name   = "name"
    values = [var.nat_instance_ami_name_filter]
  }
  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}

# NAT ì¸ìŠ¤í„´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹
resource "aws_security_group" "nat" {
  name        = "${var.project_name}-nat-instance-sg-${var.environment}"
  description = "Security group for NAT instance, allowing traffic from private subnets" # ì„¤ëª… ì—…ë°ì´íŠ¸
  vpc_id      = var.vpc_id

  # ì¸ë°”ìš´ë“œ ê·œì¹™: í”„ë¼ì´ë¹— ì„œë¸Œë„·ë“¤ë¡œë¶€í„°ì˜ ëª¨ë“  íŠ¸ë˜í”½ í—ˆìš© (ê¸°ì¡´ê³¼ ë™ì¼)
  dynamic "ingress" {
    for_each = var.private_subnet_cidrs
    content {
      description = "Allow all traffic from Private Subnet ${ingress.key + 1} (${ingress.value})"
      from_port   = 0
      to_port     = 0
      protocol    = "-1"
      cidr_blocks = [ingress.value]
    }
  }

  # ğŸ¯ ì¶”ê°€: ê´€ë¦¬ì ì•± í¬íŠ¸ë¡œì˜ ì¸ë°”ìš´ë“œ ê·œì¹™
  ingress {
    description     = "Allow access to Admin App from specified IPs"
    from_port       = var.admin_app_port
    to_port         = var.admin_app_port
    protocol        = "tcp"
    cidr_blocks     = var.admin_app_source_cidrs
  }
  
  # ì•„ì›ƒë°”ìš´ë“œ ê·œì¹™: ëª¨ë“  ì™¸ë¶€ íŠ¸ë˜í”½ í—ˆìš© (ê¸°ì¡´ê³¼ ë™ì¼)
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-nat-sg-${var.environment}"
  })
}

# NAT EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
resource "aws_instance" "nat" {
  ami           = data.aws_ami.nat_ami.id
  instance_type = var.nat_instance_type
  subnet_id     = var.public_subnet_id

  # ğŸ¯ IAM ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ ì—°ê²°
  iam_instance_profile = aws_iam_instance_profile.nat_instance_profile.name

  vpc_security_group_ids = [aws_security_group.nat.id]
  source_dest_check      = false

  user_data = <<-EOF
              #!/bin/bash
              # Enable IP forwarding
              echo "Enabling IP forwarding..."
              sudo sysctl -w net.ipv4.ip_forward=1
              echo "net.ipv4.ip_forward = 1" | sudo tee /etc/sysctl.conf
              sudo sysctl -p /etc/sysctl.conf
              echo "IP forwarding enabled."

              # Install iptables-services to make rules persistent (for Amazon Linux 2)
              echo "Installing iptables-services..."
              sudo yum install -y iptables-services
              echo "iptables-services installed."

              PRIMARY_INTERFACE=$(ip route | grep default | sed -e "s/^.*dev \([^ ]*\).*$/\1/")
              if [ -z "$PRIMARY_INTERFACE" ]; then
                echo "ERROR: Could not determine primary network interface."
                exit 1
              fi
              echo "Primary network interface: $PRIMARY_INTERFACE"

              echo "Adding MASQUERADE rule for $PRIMARY_INTERFACE..."
              sudo iptables -t nat -A POSTROUTING -o $PRIMARY_INTERFACE -j MASQUERADE
              echo "MASQUERADE rule added."

              echo "Saving iptables rules..."
              sudo iptables-save | sudo tee /etc/sysconfig/iptables
              echo "iptables rules saved."

              echo "Enabling and starting iptables service..."
              sudo systemctl enable iptables
              sudo systemctl start iptables
              echo "iptables service enabled and started."

              # Docker ì„¤ì¹˜ ë° í™œì„±í™” (ê´€ë¦¬ì ì•± ì‹¤í–‰ìš©)
              echo "Installing Docker..."
              sudo yum update -y -q
              sudo amazon-linux-extras install docker -y -q
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
              echo "Docker installed and started."

              echo "NAT configuration completed."
              EOF

  user_data_replace_on_change = true

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-nat-instance-${var.environment}"
  })
}

--- END OF modules/nat_instance/main.tf ---

--- START OF modules/nat_instance/outputs.tf ---
# modules/nat_instance/outputs.tf

output "instance_id" {
  description = "ìƒì„±ëœ NAT EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ID"
  value       = aws_instance.nat.id
}

output "primary_network_interface_id" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ID (ë¼ìš°íŒ… ê·œì¹™ ì„¤ì •ì— ì‚¬ìš©)"
  value       = aws_instance.nat.primary_network_interface_id
}

# EIPë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ EIP ê´€ë ¨ ì¶œë ¥ì€ ì œê±°
# output "public_ip" {
#   description = "NAT ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ ê³µì¸ IP ì£¼ì†Œ (Elastic IP)"
#   value       = aws_eip.nat.public_ip
# }

output "dynamic_public_ip" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ ë™ì  ê³µì¸ IP ì£¼ì†Œ (ì¸ìŠ¤í„´ìŠ¤ ì¬ì‹œì‘ ì‹œ ë³€ê²½ë  ìˆ˜ ìˆìŒ)"
  value       = aws_instance.nat.public_ip # ì¸ìŠ¤í„´ìŠ¤ì˜ ê³µì¸ IP ì†ì„± ì°¸ì¡°
}

output "private_ip" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì˜ ì‚¬ì„¤ IP ì£¼ì†Œ"
  value       = aws_instance.nat.private_ip
}

output "security_group_id" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°ëœ ë³´ì•ˆ ê·¸ë£¹ì˜ ID"
  value       = aws_security_group.nat.id
}

--- END OF modules/nat_instance/outputs.tf ---

--- START OF modules/nat_instance/variables.tf ---
# modules/nat_instance/variables.tf

variable "project_name" {
  description = "í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "environment" {
  description = "ë°°í¬ í™˜ê²½ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "common_tags" {
  description = "ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë  íƒœê·¸"
  type        = map(string)
  default     = {}
}

variable "public_subnet_id" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ê°€ ë°°í¬ë  í¼ë¸”ë¦­ ì„œë¸Œë„·ì˜ ID"
  type        = string
}

variable "vpc_id" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì˜ ë³´ì•ˆ ê·¸ë£¹ì´ ìƒì„±ë  VPCì˜ ID"
  type        = string
}

variable "private_subnet_cidrs" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•´ì•¼ í•˜ëŠ” í”„ë¼ì´ë¹— ì„œë¸Œë„· CIDR ë¸”ë¡ ëª©ë¡"
  type        = list(string)
  # ì˜ˆì‹œ: ["10.0.2.0/24", "10.0.3.0/24"]
}

variable "nat_instance_type" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ë¡œ ì‚¬ìš©í•  EC2 ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•"
  type        = string
  default     = "t2.micro" # í”„ë¦¬í‹°ì–´ í™œìš©
}

variable "nat_instance_ami_owner" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ AMI ì†Œìœ ì (Amazon Linux 2ì˜ ê²½ìš° 'amazon')"
  type        = string
  default     = "amazon"
}

variable "nat_instance_ami_name_filter" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ AMI ì´ë¦„ í•„í„° (Amazon Linux 2 ìµœì‹  ë²„ì „)"
  type        = string
  default     = "amzn2-ami-hvm-*-x86_64-gp2"
}

variable "admin_app_port" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ë  ê´€ë¦¬ì ì•±ì´ ì‚¬ìš©í•  í¬íŠ¸"
  type        = number
  default     = 8501 # ì˜ˆì‹œ í¬íŠ¸
}

variable "admin_app_source_cidrs" {
  description = "ê´€ë¦¬ì ì•±ì— ì ‘ì†ì„ í—ˆìš©í•  ì†ŒìŠ¤ IP CIDR ë¸”ë¡ ëª©ë¡"
  type        = list(string)
  default     = ["0.0.0.0/0"] # â˜¢ï¸ ë³´ì•ˆ ê²½ê³ : ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ì‚¬ë¬´ì‹¤ IP ë“± íŠ¹ì • IP ëŒ€ì—­ìœ¼ë¡œ ë°˜ë“œì‹œ ì œí•œí•˜ì„¸ìš”!
}
--- END OF modules/nat_instance/variables.tf ---

--- START OF modules/rds/main.tf ---
# modules/rds/main.tf

locals {
  module_tags = merge(var.common_tags, {
    TerraformModule = "rds"
  })

  # DB ì—”ì§„ì— ë”°ë¥¸ ê¸°ë³¸ í¬íŠ¸ ì„¤ì • (var.db_portê°€ nullì¼ ê²½ìš°)
  # aws_db_instance ë¦¬ì†ŒìŠ¤ ìì²´ë„ ì—”ì§„ì— ë”°ë¼ ê¸°ë³¸ í¬íŠ¸ë¥¼ ì˜ ì„¤ì •í•˜ì§€ë§Œ,
  # ë³´ì•ˆ ê·¸ë£¹ ë“±ì—ì„œ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì •ì˜í•©ë‹ˆë‹¤.
  db_engine_default_port = var.db_port != null ? var.db_port : (
    var.db_engine == "postgres" ? 5432 : (
      var.db_engine == "mysql" ? 3306 : null # ë‹¤ë¥¸ ì—”ì§„ ì§€ì› ì‹œ ì¶”ê°€
      # ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—”ì§„ì´ê±°ë‚˜ var.db_portë„ nullì´ë©´, ì‹¤ì œ DB ìƒì„± ì‹œ ì—”ì§„ ê¸°ë³¸ê°’ì— ì˜ì¡´
  ))
}

# 1. DB ì„œë¸Œë„· ê·¸ë£¹ ìƒì„±
# RDS ì¸ìŠ¤í„´ìŠ¤ê°€ ìœ„ì¹˜í•  í”„ë¼ì´ë¹— ì„œë¸Œë„·ë“¤ì˜ ê·¸ë£¹ì…ë‹ˆë‹¤.
resource "aws_db_subnet_group" "main" {
  name       = "${var.project_name}-rds-sng-${var.environment}"
  subnet_ids = var.db_subnet_ids # ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ ì „ë‹¬ë°›ì€ í”„ë¼ì´ë¹— DB ì„œë¸Œë„· ID ëª©ë¡

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-rds-sng-${var.environment}"
  })
}

# 2. RDS ì¸ìŠ¤í„´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹ ìƒì„±
resource "aws_security_group" "rds_sg" {
  name        = "${var.project_name}-rds-sg-${var.environment}"
  description = "Security group for RDS instance, allowing access from backend EC2 instances"
  vpc_id      = var.vpc_id

  # ì•„ì›ƒë°”ìš´ë“œ ê·œì¹™: ì¼ë°˜ì ìœ¼ë¡œ ëª¨ë“  ì•„ì›ƒë°”ìš´ë“œë¥¼ í—ˆìš© (í•„ìš”ì— ë”°ë¼ ì œí•œ ê°€ëŠ¥)
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-rds-sg-${var.environment}"
  })
}

# 3. RDS DB ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
resource "aws_db_instance" "main" {
  identifier_prefix = "${lower(var.project_name)}-rds-${lower(var.environment)}-" # ìµœì¢… ì‹ë³„ìëŠ” AWSê°€ ìœ ë‹ˆí¬í•˜ê²Œ ìƒì„±

  engine            = var.db_engine
  engine_version    = var.db_engine_version
  instance_class    = var.db_instance_class
  allocated_storage = var.db_allocated_storage
  storage_type      = var.db_storage_type
  storage_encrypted = var.storage_encrypted # ê¸°ë³¸ê°’ true ê¶Œì¥

  db_name  = var.db_name # ì´ˆê¸° ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ (ì—”ì§„ì— ë”°ë¼ ìƒì„±ë˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŒ)
  username = var.db_username
  password = var.db_password              # sensitive = true ë¡œ ì„ ì–¸ëœ ë³€ìˆ˜
  port     = local.db_engine_default_port # ëª…ì‹œì ìœ¼ë¡œ í¬íŠ¸ ì§€ì •

  db_subnet_group_name   = aws_db_subnet_group.main.name
  vpc_security_group_ids = [aws_security_group.rds_sg.id]

  multi_az            = var.multi_az            # í”„ë¦¬í‹°ì–´ëŠ” ë³´í†µ false
  publicly_accessible = var.publicly_accessible # ë³´ì•ˆìƒ false ê¶Œì¥

  backup_retention_period = var.backup_retention_period # ìë™ ë°±ì—… ë³´ì¡´ ê¸°ê°„
  skip_final_snapshot     = var.skip_final_snapshot     # ê°œë°œ/í…ŒìŠ¤íŠ¸ ì‹œ true

  # Character Set, Timezone ë“± íŒŒë¼ë¯¸í„° ê·¸ë£¹ì„ í†µí•´ ì„¤ì • ê°€ëŠ¥ (ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©)
  # parameter_group_name = aws_db_parameter_group.default.name 

  # ìœ ì§€ë³´ìˆ˜ ê¸°ê°„, ë°±ì—… ê¸°ê°„ ë“± ì„¤ì • ê°€ëŠ¥
  # maintenance_window      = "sun:03:00-sun:04:00" 
  # backup_window           = "04:00-05:00"

  # CloudWatch Logs ë¡œ ë¡œê·¸ ë‚´ë³´ë‚´ê¸° (ì„ íƒ ì‚¬í•­)
  # enabled_cloudwatch_logs_exports = ["postgresql", "upgrade"] # PostgreSQL ì˜ˆì‹œ

  apply_immediately = false # ë³€ê²½ ì‚¬í•­ì„ ë‹¤ìŒ ìœ ì§€ë³´ìˆ˜ ê¸°ê°„ì— ì ìš© (ìš´ì˜ í™˜ê²½ ê³ ë ¤)
  # ê°œë°œ ì¤‘ì—ëŠ” trueë¡œ ì„¤ì •í•˜ì—¬ ì¦‰ì‹œ ì ìš©ë˜ë„ë¡ í•  ìˆ˜ë„ ìˆìŒ

  deletion_protection = var.deletion_protection # ìš´ì˜ í™˜ê²½ì—ì„œëŠ” true ê¶Œì¥

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-rds-instance-${var.environment}"
  })
}

--- END OF modules/rds/main.tf ---

--- START OF modules/rds/outputs.tf ---
# modules/rds/outputs.tf

output "db_instance_endpoint" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì˜ ì—°ê²° ì—”ë“œí¬ì¸íŠ¸ ì£¼ì†Œ"
  value       = aws_db_instance.main.address
}

output "db_instance_port" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ê°€ ë¦¬ìŠ¤ë‹í•˜ëŠ” í¬íŠ¸"
  value       = aws_db_instance.main.port
}

output "db_instance_name" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ ì§€ì •í•œ ì´ˆê¸° ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„ (ì—”ì§„ì— ë”°ë¼ ì‹¤ì œ ìƒì„± ì—¬ë¶€ ë‹¤ë¦„)"
  value       = aws_db_instance.main.db_name # ëª¨ë“ˆ ë³€ìˆ˜ var.db_name ê³¼ ë™ì¼í•  ê²ƒì„
}

output "db_instance_identifier" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì˜ ê³ ìœ  ì‹ë³„ì"
  value       = aws_db_instance.main.identifier
}

output "db_instance_username" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì˜ ë§ˆìŠ¤í„° ì‚¬ìš©ì ì´ë¦„"
  value       = aws_db_instance.main.username # ëª¨ë“ˆ ë³€ìˆ˜ var.db_username ê³¼ ë™ì¼í•  ê²ƒì„
  sensitive   = true                          # ì‚¬ìš©ì ì´ë¦„ë„ ë¯¼ê° ì •ë³´ë¡œ ê°„ì£¼ë  ìˆ˜ ìˆìŒ
}

output "db_instance_arn" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì˜ ARN"
  value       = aws_db_instance.main.arn
}

output "db_subnet_group_name" {
  description = "ìƒì„±ëœ DB ì„œë¸Œë„· ê·¸ë£¹ì˜ ì´ë¦„"
  value       = aws_db_subnet_group.main.name
}

output "rds_security_group_id" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°ëœ ë³´ì•ˆ ê·¸ë£¹ì˜ ID"
  value       = aws_security_group.rds_sg.id
}

--- END OF modules/rds/outputs.tf ---

--- START OF modules/rds/variables.tf ---
# modules/rds/variables.tf

variable "project_name" {
  description = "í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "environment" {
  description = "ë°°í¬ í™˜ê²½ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "common_tags" {
  description = "ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë  íƒœê·¸"
  type        = map(string)
  default     = {}
}

variable "vpc_id" {
  description = "RDS ì¸ìŠ¤í„´ìŠ¤ì˜ ë³´ì•ˆ ê·¸ë£¹ì´ ìƒì„±ë  VPC ID"
  type        = string
}

variable "db_subnet_ids" {
  description = "RDS ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°°í¬í•  í”„ë¼ì´ë¹— DB ì„œë¸Œë„· ID ëª©ë¡"
  type        = list(string)
  # í˜„ì¬ ì €í¬ êµ¬ì„±ì—ì„œëŠ” ë‹¨ì¼ DB ì„œë¸Œë„·ì„ ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ, ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ [module.vpc.private_db_subnet_id] ì™€ ê°™ì´ ì „ë‹¬í•©ë‹ˆë‹¤.
}

variable "db_engine" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ (ì˜ˆ: postgres, mysql, oracle-se2, sqlserver-ex)"
  type        = string
  default     = "postgres"
}

variable "db_engine_version" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ ë²„ì „"
  type        = string
  # ì—”ì§„ì— ë”°ë¼ ìœ íš¨í•œ ë²„ì „ì„ AWS ì„¤ëª…ì„œì—ì„œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.
  default = "17.4"
}

variable "db_instance_class" {
  description = "RDS ì¸ìŠ¤í„´ìŠ¤ ìœ í˜• (í”„ë¦¬í‹°ì–´: db.t3.micro ë˜ëŠ” db.t4g.micro - ë¦¬ì „/ì—”ì§„ë³„ ì§€ì› í™•ì¸)"
  type        = string
  default     = "db.t4g.micro" # PostgreSQL í”„ë¦¬í‹°ì–´ ê°€ëŠ¥ (20GB ìŠ¤í† ë¦¬ì§€ì™€ í•¨ê»˜)
}

variable "db_allocated_storage" {
  description = "í• ë‹¹ëœ ìŠ¤í† ë¦¬ì§€ í¬ê¸° (GB, í”„ë¦¬í‹°ì–´: 20GB)"
  type        = number
  default     = 20
}

variable "db_storage_type" {
  description = "ìŠ¤í† ë¦¬ì§€ ìœ í˜• (gp2, gp3, io1 ë“±)"
  type        = string
  default     = "gp3" # gp2ë³´ë‹¤ ì„±ëŠ¥ ë° ë¹„ìš© íš¨ìœ¨ì´ ì¢‹ìŒ
}

variable "db_name" {
  description = "ìƒì„±í•  ë°ì´í„°ë² ì´ìŠ¤ì˜ ì´ˆê¸° ì´ë¦„ (DB ì‹ë³„ì ì•„ë‹˜)"
  type        = string
  default     = "fastapidb" # ì˜ˆì‹œ
}

variable "db_username" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ ë§ˆìŠ¤í„° ì‚¬ìš©ì ì´ë¦„"
  type        = string
  default     = "dbadmin"
}

variable "db_password" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ ë§ˆìŠ¤í„° ì‚¬ìš©ì ì•”í˜¸ (ë§¤ìš° ë¯¼ê°í•œ ì •ë³´!)"
  type        = string
  sensitive   = true # Terraform ì¶œë ¥ì— í‘œì‹œë˜ì§€ ì•Šë„ë¡ í•¨
  # ì´ ê°’ì€ Terraform Cloud ë³€ìˆ˜(ë¯¼ê°) ë˜ëŠ” AWS Secrets Managerë¥¼ í†µí•´ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤.
  # ë£¨íŠ¸ ëª¨ë“ˆì—ì„œ ê°’ì„ ì „ë‹¬ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.
}

variable "multi_az" {
  description = "ë‹¤ì¤‘ AZ ë°°í¬ ì—¬ë¶€ (í”„ë¦¬í‹°ì–´ì—ì„œëŠ” ë³´í†µ false)"
  type        = bool
  default     = false
}

variable "publicly_accessible" {
  description = "RDS ì¸ìŠ¤í„´ìŠ¤ì— ê³µì¸ IP í• ë‹¹ ì—¬ë¶€ (ë³´ì•ˆìƒ false ê¶Œì¥)"
  type        = bool
  default     = false
}

variable "skip_final_snapshot" {
  description = "DB ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ ì‹œ ìµœì¢… ìŠ¤ëƒ…ìƒ· ìƒì„± ì—¬ë¶€ (ê°œë°œ/í…ŒìŠ¤íŠ¸ ì‹œ true)"
  type        = bool
  default     = true
}

variable "backup_retention_period" {
  description = "ìë™ ë°±ì—… ë³´ì¡´ ê¸°ê°„ (ì¼, 0ì´ë©´ ë¹„í™œì„±í™”, í”„ë¦¬í‹°ì–´ëŠ” 7ì¼ ê°€ëŠ¥)"
  type        = number
  default     = 0 # ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ë¹„í™œì„±í™”, í•„ìš”ì‹œ 7 ì´ìƒìœ¼ë¡œ ì„¤ì •
}

variable "storage_encrypted" {
  description = "ìŠ¤í† ë¦¬ì§€ ì•”í˜¸í™” ì‚¬ìš© ì—¬ë¶€"
  type        = bool
  default     = true
}

variable "deletion_protection" {
  description = "ì‚­ì œ ë°©ì§€ ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€ (ìš´ì˜ í™˜ê²½ì—ì„œëŠ” true ê¶Œì¥)"
  type        = bool
  default     = false # ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©
}

variable "db_port" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ ì—”ì§„ í¬íŠ¸ (ì´ ë³€ìˆ˜ëŠ” ì§ì ‘ ì‚¬ìš©ë˜ê¸°ë³´ë‹¤ ë‚´ë¶€ì ìœ¼ë¡œ ì—”ì§„ì— ë”°ë¼ ê²°ì •ë¨)"
  type        = number
  default     = null # nullë¡œ ë‘ë©´ ì—”ì§„ ê¸°ë³¸ í¬íŠ¸ ì‚¬ìš© (PostgreSQL: 5432, MySQL: 3306)
}

--- END OF modules/rds/variables.tf ---

--- START OF modules/vpc/main.tf ---
# modules/vpc/main.tf

# ëª¨ë“ˆ ë‚´ ë¦¬ì†ŒìŠ¤ì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë  íƒœê·¸ë¥¼ ìœ„í•œ local ë³€ìˆ˜
locals {
  module_tags = merge(var.common_tags, {
    TerraformModule = "vpc"
    Name            = "${var.project_name}-vpc-${var.environment}"
  })
}

# 1. Virtual Private Cloud (VPC) ìƒì„±
resource "aws_vpc" "main" {
  cidr_block           = var.vpc_cidr_block
  enable_dns_support   = true
  enable_dns_hostnames = true

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-vpc-${var.environment}"
  })
}

# 2. ì„œë¸Œë„· ìƒì„±
# 2-1. í¼ë¸”ë¦­ ì„œë¸Œë„·
resource "aws_subnet" "public" {

  for_each = {
    for i, az in var.availability_zones : i => {
      az   = az
      cidr = var.public_subnet_cidrs[i]
    }
  }

  vpc_id                  = aws_vpc.main.id
  cidr_block              = each.value.cidr
  availability_zone       = each.value.az
  map_public_ip_on_launch = true

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-public-subnet-${each.value.az}-${var.environment}"
    Tier = "Public"
    AZ   = each.value.az
  })
}

# 2-2. í”„ë¼ì´ë¹— ì„œë¸Œë„· (FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„ìš©)
resource "aws_subnet" "private_app" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = var.private_subnet_app_cidr
  availability_zone       = var.primary_availability_zone # ë‹¨ì¼ AZ ì§€ì •
  map_public_ip_on_launch = false

  tags = merge(local.module_tags, {
    Name  = "${var.project_name}-private-app-subnet-${var.primary_availability_zone}-${var.environment}"
    Tier  = "Private"
    AZ    = var.primary_availability_zone
    Usage = "Application"
  })
}

# 2-3. í”„ë¼ì´ë¹— ì„œë¸Œë„· (RDS ë°ì´í„°ë² ì´ìŠ¤ìš©)
resource "aws_subnet" "private_db" {
  for_each = {
    for i, az in var.availability_zones : i => { # public ì„œë¸Œë„·ê³¼ ë™ì¼í•œ AZ ëª©ë¡ ì‚¬ìš©
      az   = az
      cidr = var.private_db_subnet_cidrs[i] # DBìš© CIDR ëª©ë¡ ì‚¬ìš©
    }
  }

  vpc_id                  = aws_vpc.main.id
  cidr_block              = each.value.cidr
  availability_zone       = each.value.az # ğŸ‘ˆ ì‹¤ì œ ì„œë¸Œë„·ì´ ìƒì„±ë  AZ
  map_public_ip_on_launch = false

  tags = merge(local.module_tags, {
    Name  = "${var.project_name}-private-db-subnet-${each.value.az}-${var.environment}"
    Tier  = "Private"
    AZ    = each.value.az
    Usage = "Database"
  })
}


# 3. ì¸í„°ë„· ê²Œì´íŠ¸ì›¨ì´ (IGW) ìƒì„± ë° VPCì— ì—°ê²°
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-igw-${var.environment}"
  })
}

# 4. í¼ë¸”ë¦­ ë¼ìš°íŠ¸ í…Œì´ë¸” ìƒì„± ë° ì„¤ì • (ëª¨ë“  í¼ë¸”ë¦­ ì„œë¸Œë„·ì— ë™ì¼í•œ ë¼ìš°íŠ¸ í…Œì´ë¸” ì—°ê²°)
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }

  tags = merge(local.module_tags, {
    Name = "${var.project_name}-public-rt-${var.environment}"
    Tier = "Public"
  })
}

# ìƒì„±ëœ ëª¨ë“  í¼ë¸”ë¦­ ì„œë¸Œë„·ì— ìœ„ ë¼ìš°íŠ¸ í…Œì´ë¸” ì—°ê²°
resource "aws_route_table_association" "public" {
  for_each       = aws_subnet.public # aws_subnet.publicì´ for_eachë¡œ ìƒì„±ë˜ë¯€ë¡œ, associationë„ for_each ì‚¬ìš©
  subnet_id      = each.value.id
  route_table_id = aws_route_table.public.id
}

# 6. í”„ë¼ì´ë¹— ë¼ìš°íŠ¸ í…Œì´ë¸” ìƒì„± (âš ï¸ ì¤‘ìš”: 0.0.0.0/0 ë¼ìš°íŒ… ê·œì¹™ì€ ì—¬ê¸°ì„œ ì œê±°)
# 6-1. í”„ë¼ì´ë¹— ì„œë¸Œë„·(App)ìš© ë¼ìš°íŠ¸ í…Œì´ë¸”
resource "aws_route_table" "private_app" {
  vpc_id = aws_vpc.main.id

  tags = merge(local.module_tags, {
    Name  = "${var.project_name}-private-app-rt-${var.environment}"
    Tier  = "Private"
    Usage = "Application"
  })
}

resource "aws_route_table_association" "private_app" {
  subnet_id      = aws_subnet.private_app.id
  route_table_id = aws_route_table.private_app.id
}

# 6-2. í”„ë¼ì´ë¹— ì„œë¸Œë„·(DB)ìš© ë¼ìš°íŠ¸ í…Œì´ë¸”
resource "aws_route_table" "private_db" {
  vpc_id = aws_vpc.main.id

  tags = merge(local.module_tags, {
    Name  = "${var.project_name}-private-db-rt-${var.environment}"
    Tier  = "Private"
    Usage = "Database"
  })
}

# í”„ë¼ì´ë¹— DB ì„œë¸Œë„·ë“¤ì— ëŒ€í•œ ë¼ìš°íŠ¸ í…Œì´ë¸” ì—°ê²°(association)ë„ for_eachë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
# ì˜ˆë¥¼ ë“¤ì–´, ëª¨ë“  DB ì„œë¸Œë„·ì´ ë™ì¼í•œ (NATë¡œ í–¥í•˜ëŠ”) í”„ë¼ì´ë¹— ë¼ìš°íŠ¸ í…Œì´ë¸”ì„ ì‚¬ìš©í•œë‹¤ë©´:
resource "aws_route_table_association" "private_db" {
  for_each       = aws_subnet.private_db # aws_subnet.private_dbê°€ for_eachë¡œ ìƒì„±ë˜ë¯€ë¡œ
  subnet_id      = each.value.id
  route_table_id = aws_route_table.private_db.id # private_db_rt ë¥¼ ì°¸ì¡° (ì´ë¦„ í™•ì¸ í•„ìš”, ì˜ˆì‹œì„)
  # ë˜ëŠ” ê° AZë³„ë¡œ ë³„ë„ì˜ ë¼ìš°íŠ¸ í…Œì´ë¸”ì„ ê°€ì§ˆ ìˆ˜ë„ ìˆìŒ
}

--- END OF modules/vpc/main.tf ---

--- START OF modules/vpc/outputs.tf ---
# modules/vpc/outputs.tf

output "vpc_id" {
  description = "ìƒì„±ëœ VPCì˜ ID"
  value       = aws_vpc.main.id
}

output "vpc_cidr_block" {
  description = "VPCì— í• ë‹¹ëœ CIDR ë¸”ë¡"
  value       = aws_vpc.main.cidr_block
}

output "public_subnet_ids" { # ğŸ‘ˆ ì´ë¦„ ë³€ê²½ ë° ê°’ ìˆ˜ì •
  description = "ìƒì„±ëœ ëª¨ë“  í¼ë¸”ë¦­ ì„œë¸Œë„·ì˜ ID ëª©ë¡"
  value       = [for subnet in aws_subnet.public : subnet.id]
}

output "public_subnet_cidr_blocks" {
  description = "ìƒì„±ëœ ëª¨ë“  í¼ë¸”ë¦­ ì„œë¸Œë„·ì˜ CIDR ë¸”ë¡ ëª©ë¡"
  value       = [for subnet in aws_subnet.public : subnet.cidr_block]
}

output "public_subnet_availability_zones" {
  description = "ìƒì„±ëœ ëª¨ë“  í¼ë¸”ë¦­ ì„œë¸Œë„·ì´ ìœ„ì¹˜í•œ ê°€ìš© ì˜ì—­ ëª©ë¡"
  value       = [for subnet in aws_subnet.public : subnet.availability_zone]
}

output "private_app_subnet_id" {
  description = "ìƒì„±ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„·ì˜ ID"
  value       = aws_subnet.private_app.id
}

output "private_app_subnet_cidr_block" {
  description = "ì• í”Œë¦¬ì¼€ì´ì…˜ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— í• ë‹¹ëœ CIDR ë¸”ë¡"
  value       = aws_subnet.private_app.cidr_block
}

output "private_app_subnet_availability_zone" {
  description = "ì• í”Œë¦¬ì¼€ì´ì…˜ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„·ì´ ìœ„ì¹˜í•œ ê°€ìš© ì˜ì—­"
  value       = aws_subnet.private_app.availability_zone
}

output "private_db_subnet_ids" {
  description = "ìƒì„±ëœ ëª¨ë“  í”„ë¼ì´ë¹— DB ì„œë¸Œë„·ì˜ ID ëª©ë¡"
  value       = [for subnet in aws_subnet.private_db : subnet.id]
}

output "private_db_subnet_cidr_blocks" {
  description = "ìƒì„±ëœ ëª¨ë“  í”„ë¼ì´ë¹— DB ì„œë¸Œë„·ì˜ CIDR ë¸”ë¡ ëª©ë¡"
  value       = [for subnet in aws_subnet.private_db : subnet.cidr_block]
}

output "private_db_subnet_availability_zones" {
  description = "ìƒì„±ëœ ëª¨ë“  í”„ë¼ì´ë¹— DB ì„œë¸Œë„·ì´ ìœ„ì¹˜í•œ ê°€ìš© ì˜ì—­ ëª©ë¡"
  value       = [for subnet in aws_subnet.private_db : subnet.availability_zone]
}

output "private_app_route_table_id" {
  description = "ì• í”Œë¦¬ì¼€ì´ì…˜ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ì—°ê²°ëœ ë¼ìš°íŠ¸ í…Œì´ë¸”ì˜ ID"
  value       = aws_route_table.private_app.id
}

output "private_db_route_table_id" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„·ì— ì—°ê²°ëœ ë¼ìš°íŠ¸ í…Œì´ë¸”ì˜ ID"
  value       = aws_route_table.private_db.id
}

--- END OF modules/vpc/outputs.tf ---

--- START OF modules/vpc/variables.tf ---
# modules/vpc/variables.tf

variable "aws_region" {
  description = "AWS ë¦¬ì „ (ì˜ˆ: ap-northeast-2)"
  type        = string
}

variable "project_name" {
  description = "í”„ë¡œì íŠ¸ ì´ë¦„ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "environment" {
  description = "ë°°í¬ í™˜ê²½ (ë¦¬ì†ŒìŠ¤ íƒœê¹… ë° ì´ë¦„ì— ì‚¬ìš©)"
  type        = string
}

variable "common_tags" {
  description = "ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ê³µí†µì ìœ¼ë¡œ ì ìš©ë  íƒœê·¸"
  type        = map(string)
  default     = {}
}

variable "vpc_cidr_block" {
  description = "VPCì— í• ë‹¹í•  CIDR ë¸”ë¡"
  type        = string
  default     = "10.0.0.0/16"
}

variable "availability_zones" {
  description = "ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•  ê°€ìš© ì˜ì—­ ëª©ë¡"
  type        = list(string)
}

variable "public_subnet_cidrs" {
  description = "ê° ê°€ìš© ì˜ì—­ì— ìƒì„±í•  í¼ë¸”ë¦­ ì„œë¸Œë„· CIDR ë¸”ë¡ ëª©ë¡"
  type        = list(string)
}

variable "private_subnet_app_cidr" {
  description = "FastAPI ì•± ì„œë²„ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„· CIDR ë¸”ë¡"
  type        = string
}

variable "private_db_subnet_cidrs" {
  description = "ê° ê°€ìš© ì˜ì—­ì— ìƒì„±í•  í”„ë¼ì´ë¹— DB ì„œë¸Œë„· CIDR ë¸”ë¡ ëª©ë¡"
  type        = list(string)
}

# í”„ë¼ì´ë¹— ì„œë¸Œë„·ì„ ìœ„í•œ ë‹¨ì¼ AZ ì§€ì • ë³€ìˆ˜ (ê¸°ì¡´ private_subnet_app/dbê°€ ì‚¬ìš©í•  AZ)
# ë§Œì•½ í”„ë¼ì´ë¹— ì„œë¸Œë„·ë„ Multi-AZë¡œ í™•ì¥í•œë‹¤ë©´ ì´ ë³€ìˆ˜ëŠ” í•„ìš” ì—†ì–´ì§€ê±°ë‚˜ ë‹¤ë¥´ê²Œ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
variable "primary_availability_zone" {
  description = "ì£¼ìš” í”„ë¼ì´ë¹— ë¦¬ì†ŒìŠ¤(ì˜ˆ: í˜„ì¬ êµ¬ì„±ì˜ í”„ë¼ì´ë¹— ì„œë¸Œë„·)ë¥¼ ë°°í¬í•  ë‹¨ì¼ ê°€ìš© ì˜ì—­"
  type        = string
  # ì˜ˆ: var.availability_zones[0] ê°’ì„ ë£¨íŠ¸ì—ì„œ ì „ë‹¬ë°›ë„ë¡ í•  ìˆ˜ ìˆìŒ
}

--- END OF modules/vpc/variables.tf ---

--- START OF outputs.tf ---
# terraform-aws-fastapi-infra/outputs.tf

output "vpc_id" {
  description = "ìƒì„±ëœ VPCì˜ ID"
  value       = module.vpc.vpc_id
  sensitive   = false # IDëŠ” ë¯¼ê° ì •ë³´ê°€ ì•„ë‹˜
}

output "all_public_subnet_ids" {
  description = "ìƒì„±ëœ ëª¨ë“  í¼ë¸”ë¦­ ì„œë¸Œë„· ID ëª©ë¡"
  value       = module.vpc.public_subnet_ids
}

output "private_app_subnet_id" {
  description = "ìƒì„±ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„·ì˜ ID"
  value       = module.vpc.private_app_subnet_id
}

output "all_private_db_subnet_ids" {
  description = "ìƒì„±ëœ ëª¨ë“  í”„ë¼ì´ë¹— DB ì„œë¸Œë„· ID ëª©ë¡"
  value       = module.vpc.private_db_subnet_ids # ğŸ‘ˆ VPC ëª¨ë“ˆì˜ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ê°’ ì „ì²´ë¥¼ ì‚¬ìš©
}

output "private_app_route_table_id" {
  description = "ì• í”Œë¦¬ì¼€ì´ì…˜ìš© í”„ë¼ì´ë¹— ë¼ìš°íŠ¸ í…Œì´ë¸” ID (NAT ë¼ìš°íŒ… ì¶”ê°€ì— ì‚¬ìš©)"
  value       = module.vpc.private_app_route_table_id
}

output "private_db_route_table_id" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ìš© í”„ë¼ì´ë¹— ë¼ìš°íŠ¸ í…Œì´ë¸” ID (NAT ë¼ìš°íŒ… ì¶”ê°€ì— ì‚¬ìš©)"
  value       = module.vpc.private_db_route_table_id
}

output "vpc_module_outputs" {
  description = "VPC ëª¨ë“ˆì˜ ëª¨ë“  ì¶œë ¥ê°’ (ë””ë²„ê¹…ìš©)"
  value       = module.vpc # ëª¨ë“ˆ ì „ì²´ë¥¼ ì¶œë ¥í•˜ë©´ ëª¨ë“  outputì´ ë‚˜ì˜´
  sensitive   = true       # ë‚´ë¶€ì ìœ¼ë¡œ ë¯¼ê°í•œ ì •ë³´ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ trueë¡œ ì„¤ì • ê¶Œì¥
}

output "nat_instance_id" {
  description = "ìƒì„±ëœ NAT ì¸ìŠ¤í„´ìŠ¤ì˜ ID"
  value       = module.nat_instance.instance_id
}

output "nat_instance_dynamic_public_ip" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì— í• ë‹¹ëœ ë™ì  ê³µì¸ IP ì£¼ì†Œ (ì£¼ì˜: ì¬ì‹œì‘ ì‹œ ë³€ê²½ ê°€ëŠ¥)"
  value       = module.nat_instance.dynamic_public_ip # ëª¨ë“ˆì˜ ìƒˆ ì¶œë ¥ ì°¸ì¡°
}

output "nat_instance_private_ip" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì˜ ì‚¬ì„¤ IP ì£¼ì†Œ"
  value       = module.nat_instance.private_ip
}

output "nat_instance_primary_network_interface_id" {
  description = "NAT ì¸ìŠ¤í„´ìŠ¤ì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ID"
  value       = module.nat_instance.primary_network_interface_id
}

output "backend_asg_name" {
  description = "ë°±ì—”ë“œ Auto Scaling Groupì˜ ì´ë¦„"
  value       = module.ec2_backend.asg_name
}

output "backend_security_group_id" {
  description = "ë°±ì—”ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ìš© ë³´ì•ˆ ê·¸ë£¹ ID (ALB ì„¤ì •ì— í•„ìš”)"
  value       = module.ec2_backend.security_group_id
}

output "backend_launch_template_id" {
  description = "ë°±ì—”ë“œ EC2 ì¸ìŠ¤í„´ìŠ¤ìš© ì‹œì‘ í…œí”Œë¦¿ ID"
  value       = module.ec2_backend.launch_template_id
}

output "alb_dns_name" {
  description = "ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œ ë°¸ëŸ°ì„œì˜ DNS ì£¼ì†Œ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì† URL)"
  value       = module.alb.alb_dns_name
}

output "rds_instance_endpoint" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ ì—°ê²° ì—”ë“œí¬ì¸íŠ¸ ì£¼ì†Œ"
  value       = module.rds.db_instance_endpoint
}

output "rds_instance_port" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ ì—°ê²° í¬íŠ¸"
  value       = module.rds.db_instance_port
}

output "rds_db_name" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì˜ ì´ˆê¸° ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„"
  value       = module.rds.db_instance_name # ëª¨ë“ˆ ì¶œë ¥ê°’ ì°¸ì¡°
}

output "rds_db_username" {
  description = "RDS DB ì¸ìŠ¤í„´ìŠ¤ì˜ ë§ˆìŠ¤í„° ì‚¬ìš©ì ì´ë¦„"
  value       = module.rds.db_instance_username # ëª¨ë“ˆ ì¶œë ¥ê°’ ì°¸ì¡°
  sensitive   = true
}

output "ecr_repository_url" {
  description = "ìƒì„±ëœ Amazon ECR ë¦¬í¬ì§€í† ë¦¬ì˜ URL"
  value       = aws_ecr_repository.fastapi_app.repository_url
}

output "admin_app_ecr_repository_url" {
  description = "ê´€ë¦¬ì ì• í”Œë¦¬ì¼€ì´ì…˜ìš© Amazon ECR ë¦¬í¬ì§€í† ë¦¬ì˜ URL"
  value       = aws_ecr_repository.admin_app.repository_url
}

output "acm_certificate_arn_validated" {
  description = "The ARN of the validated ACM certificate used for the ALB."
  value       = module.acm.validated_certificate_arn
}

--- END OF outputs.tf ---

--- START OF providers.tf ---
# terraform-aws-fastapi-infra/provider.tf

provider "aws" {
  region = var.aws_region
}

provider "cloudflare" {
  # í…Œë¼í¼ í´ë¼ìš°ë“œì—ì„œ CLOUDFLARE_API_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
}

--- END OF providers.tf ---

--- START OF variables.tf ---
# terraform-aws-fastapi-infra/variables.tf

variable "custom_fastapi_docker_image" {
  description = "ë°°í¬í•  ì‚¬ìš©ì ì •ì˜ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ Docker ì´ë¯¸ì§€ URI"
  type        = string
  default     = "tiangolo/uvicorn-gunicorn-fastapi:python3.9" # ê¸°ë³¸ê°’ ë˜ëŠ” ì´ì „ ë²„ì „ ì´ë¯¸ì§€
}

variable "aws_region" {
  description = "AWS ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•  ë¦¬ì „ì…ë‹ˆë‹¤."
  type        = string
  default     = "ap-northeast-2"
}

variable "project_name" {
  description = "í”„ë¡œì íŠ¸ ì´ë¦„ íƒœê·¸ ë“±ì— ì‚¬ìš©ë©ë‹ˆë‹¤."
  type        = string
  default     = "fastapi-infra"
}

variable "environment" {
  description = "ë°°í¬ í™˜ê²½ (ì˜ˆ: dev, stg, prod)"
  type        = string
  default     = "dev"
}

variable "availability_zones" {
  description = "ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•  ê°€ìš© ì˜ì—­ ëª©ë¡ (ìµœì†Œ 2ê°œ ê¶Œì¥)"
  type        = list(string)
  default     = ["ap-northeast-2a", "ap-northeast-2c"] # ì˜ˆì‹œ: ì„œìš¸ ë¦¬ì „ì˜ a, c ì˜ì—­
}

# VPC ë° NAT Instance ëª¨ë“ˆì—ì„œ ì‚¬ìš©í•  CIDR ë³€ìˆ˜ë“¤
variable "vpc_cidr_block" {
  description = "VPCì— í• ë‹¹í•  CIDR ë¸”ë¡"
  type        = string
  default     = "10.0.0.0/16" # VPC ëª¨ë“ˆì˜ ê¸°ë³¸ê°’ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ê±°ë‚˜ í•„ìš”ì‹œ ìˆ˜ì •
}

variable "public_subnet_cidrs" {
  description = "ê° ê°€ìš© ì˜ì—­ì— ìƒì„±í•  í¼ë¸”ë¦­ ì„œë¸Œë„· CIDR ë¸”ë¡ ëª©ë¡"
  type        = list(string)
  default     = ["10.0.100.0/24", "10.0.101.0/24"] # ì˜ˆì‹œ: 2ê°œì˜ CIDR ë¸”ë¡
}

variable "private_subnet_app_cidr" {
  description = "FastAPI ì•± ì„œë²„ìš© í”„ë¼ì´ë¹— ì„œë¸Œë„· CIDR ë¸”ë¡"
  type        = string
  default     = "10.0.2.0/24" # VPC ëª¨ë“ˆì˜ ê¸°ë³¸ê°’ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ê±°ë‚˜ í•„ìš”ì‹œ ìˆ˜ì •
}

variable "private_db_subnet_cidrs" { # ğŸ‘ˆ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë³€ê²½ ë˜ëŠ” ì‹ ê·œ ì¶”ê°€
  description = "ê° ê°€ìš© ì˜ì—­ì— ìƒì„±í•  í”„ë¼ì´ë¹— DB ì„œë¸Œë„· CIDR ë¸”ë¡ ëª©ë¡"
  type        = list(string)
  default     = ["10.0.30.0/24", "10.0.103.0/24"] # ì˜ˆì‹œ: 2ê°œì˜ CIDR ë¸”ë¡ (public_subnet_cidrsì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ)
}

# NAT ì¸ìŠ¤í„´ìŠ¤ ì ‘ì†ìš© ë³€ìˆ˜

variable "backend_app_port" {
  description = "ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” í¬íŠ¸"
  type        = number
  default     = 80
}

variable "db_password" {
  description = "ë°ì´í„°ë² ì´ìŠ¤ ë§ˆìŠ¤í„° ì‚¬ìš©ì ì•”í˜¸"
  type        = string
  sensitive   = true
}

variable "fastapi_secret_key" {
  description = "FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ JWT ì‹œí¬ë¦¿ í‚¤"
  type        = string
  sensitive   = true
}

variable "firebase_b64_json" {
  description = "Base64ë¡œ ì¸ì½”ë”©ëœ Firebase ì„œë¹„ìŠ¤ ê³„ì • JSON"
  type        = string
  sensitive   = true
}

variable "domain_name" {
  description = "The primary domain name for which the SSL certificate will be issued (e.g., 'example.com'). This will also be used as the Cloudflare zone name if not overridden."
  type        = string
  # ì´ ê°’ì€ Terraform Cloud ë³€ìˆ˜ë¥¼ í†µí•´ ì£¼ì…ë©ë‹ˆë‹¤.
}

variable "subdomain_for_cert" {
  description = "Optional subdomain to include in the certificate as a Subject Alternative Name (e.g., 'www', 'api'). If empty, only the primary_domain_name is used."
  type        = string
  default     = "www" # ê¸°ë³¸ì ìœ¼ë¡œ www.domain_name ì„ SANìœ¼ë¡œ í¬í•¨
}

variable "cloudflare_zone_id" {
  description = "The Cloudflare Zone ID corresponding to your domain_name. This is required for DNS validation of the ACM certificate."
  type        = string
  # ì´ ê°’ì€ Terraform Cloud ë³€ìˆ˜(ë¯¼ê° ì •ë³´ì¼ ìˆ˜ ìˆìŒ)ë¥¼ í†µí•´ ì£¼ì…ë©ë‹ˆë‹¤.
}

--- END OF variables.tf ---

--- START OF versions.tf ---
# terraform-aws-fastapi-infra/versions.tf

terraform {
  required_version = ">= 1.12.0" # Terraform ìµœì†Œ ê¶Œì¥ ë²„ì „

  # Terraform Cloud ì—°ë™ ì„¤ì •
  # VCS ê¸°ë°˜ ì›Œí¬í”Œë¡œìš°ì—ì„œëŠ” ì´ ë¸”ë¡ì´ ì—†ì–´ë„ TFCê°€ ìë™ìœ¼ë¡œ workspaceì™€ ì—°ê²°í•˜ì§€ë§Œ,
  # ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸í•´ë‘ë©´ ë¡œì»¬ì—ì„œ `terraform init` ì‹œ í˜¼ë™ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  cloud {
    organization = "meongtamjeongai"
    workspaces {
      name = "meongtamjeongai-devops"
    }
  }

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }

    cloudflare = {
      source  = "cloudflare/cloudflare"
      version = "~> 5"
    }
  }
}

--- END OF versions.tf ---

